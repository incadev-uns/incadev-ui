---
// src/pages/marketing/propuestas/[id].astro
import Layout from "../../../layouts/MarketingLayout.astro";

// ‚úÖ Activar SSR (renderizado din√°mico)
export const prerender = false;

const { id } = Astro.params;

// Mock temporal solo para el t√≠tulo inicial de la p√°gina
const mockTitle = "Propuesta - INCADEV UI";
---

<Layout title={mockTitle}>
  <div class="space-y-6" data-proposal-id={id}>
    <!-- Breadcrumb -->
    <nav
      class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400"
    >
      <a
        href="/marketing/dashboard"
        class="hover:text-blue-600 dark:hover:text-blue-400 smooth-transition"
        >Dashboard</a
      >
      <span>/</span>
      <a
        href="/marketing/propuestas"
        class="hover:text-blue-600 dark:hover:text-blue-400 smooth-transition"
        >Propuestas</a
      >
      <span>/</span>
      <span id="breadcrumbTitle" class="text-gray-900 dark:text-white"
        >Cargando...</span
      >
    </nav>

    <!-- Loading State -->
    <div
      id="loadingState"
      class="bg-white dark:bg-gray-950 rounded-xl border border-gray-200 dark:border-gray-800 p-12 text-center"
    >
      <div
        class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"
      >
      </div>
      <p class="text-gray-600 dark:text-gray-400">Cargando propuesta...</p>
    </div>

    <!-- Error State -->
    <div
      id="errorState"
      class="hidden bg-white dark:bg-gray-950 rounded-xl border border-gray-200 dark:border-gray-800 p-12 text-center"
    >
      <div
        class="w-20 h-20 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4"
      >
        <svg
          class="w-10 h-10 text-red-600 dark:text-red-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
        Error al cargar la propuesta
      </h3>
      <p id="errorMessage" class="text-gray-600 dark:text-gray-400 mb-4"></p>
      <button
        onclick="window.location.reload()"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
      >
        Reintentar
      </button>
    </div>

    <!-- Main Content (se mostrar√° cuando cargue) -->
    <div id="mainContent" class="hidden space-y-6">
      <!-- Header Din√°mico -->
      <div
        class="bg-white dark:bg-gray-950 rounded-xl border border-gray-200 dark:border-gray-800 p-6"
      >
        <div class="flex items-start justify-between mb-4">
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-3 flex-wrap">
              <h1
                id="propuestaTitulo"
                class="text-3xl font-bold text-gray-900 dark:text-white"
              >
                <!-- Se llenar√° din√°micamente -->
              </h1>

              <!-- Badge Estado -->
              <span
                id="propuestaEstadoBadge"
                class="px-3 py-1 rounded-full text-sm font-medium"
              >
                <!-- Se llenar√° din√°micamente -->
              </span>

              <!-- Badge Prioridad -->
              <span
                id="propuestaPrioridadBadge"
                class="px-3 py-1 rounded-full text-sm font-medium"
              >
                <!-- Se llenar√° din√°micamente -->
              </span>
            </div>

            <p
              id="propuestaDescripcion"
              class="text-gray-600 dark:text-gray-400 mb-4"
            >
              <!-- Se llenar√° din√°micamente -->
            </p>

            <!-- Informaci√≥n b√°sica -->
            <div id="propuestaInfo" class="flex flex-wrap gap-4 text-sm">
              <!-- Se llenar√° din√°micamente -->
            </div>
          </div>

          <!-- Botones Din√°micos seg√∫n Estado -->
          <div class="flex gap-2">
            <button
              class="px-4 py-2 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-900 smooth-transition"
            >
              Editar
            </button>
            <span id="propuestaAcciones">
              <!-- Se llenar√° din√°micamente seg√∫n estado -->
            </span>
          </div>
        </div>

        <!-- P√∫blico Objetivo -->
        <div class="pt-4 border-t border-gray-200 dark:border-gray-800">
          <p class="text-sm font-semibold text-gray-900 dark:text-white mb-2">
            P√∫blico Objetivo:
          </p>
          <div id="propuestaPublico" class="flex gap-2 flex-wrap">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        <!-- M√©tricas R√°pidas (solo si no es borrador) -->
        <div
          id="quickMetricsContainer"
          class="hidden pt-4 mt-4 border-t border-gray-200 dark:border-gray-800"
        >
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="quickMetrics">
            <!-- Se cargar√°n con JavaScript -->
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div
        class="bg-white dark:bg-gray-950 rounded-xl border border-gray-200 dark:border-gray-800"
      >
        <div class="border-b border-gray-200 dark:border-gray-800">
          <nav class="flex gap-1 p-2 overflow-x-auto">
            <button
              class="tab-btn px-6 py-3 rounded-lg font-medium smooth-transition bg-blue-50 dark:bg-blue-950/30 text-blue-600 dark:text-blue-400 whitespace-nowrap"
              data-tab="campa√±as"
            >
              Campa√±as
            </button>
            <button
              class="tab-btn px-6 py-3 rounded-lg font-medium smooth-transition text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-900 whitespace-nowrap"
              data-tab="viabilidad"
            >
              An√°lisis de Viabilidad
            </button>
            <button
              class="tab-btn px-6 py-3 rounded-lg font-medium smooth-transition text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-900 whitespace-nowrap"
              data-tab="metricas"
            >
              M√©tricas Detalladas
            </button>
            <button
              class="tab-btn px-6 py-3 rounded-lg font-medium smooth-transition text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-900 whitespace-nowrap"
              data-tab="recursos"
            >
              Recursos
            </button>
          </nav>
        </div>

        <!-- Tab Content: Campa√±as -->
        <div id="tab-campa√±as" class="tab-content p-6">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-1">
                Campa√±as de Validaci√≥n
              </h2>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                Campa√±as educativas para medir el inter√©s del mercado
              </p>
            </div>
            <button
              id="btnNuevaCampa√±a"
              class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-medium smooth-transition flex items-center gap-2 shadow-lg"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"></path>
              </svg>
              Nueva Campa√±a
            </button>
          </div>

          <!-- Campa√±as Grid -->
          <div id="campa√±asList" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Las campa√±as se cargar√°n aqu√≠ -->
          </div>

          <!-- Empty State -->
          <div id="emptyCampa√±as" class="hidden text-center py-12">
            <div
              class="w-20 h-20 bg-gray-100 dark:bg-gray-900 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <svg
                class="w-10 h-10 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"
                ></path>
              </svg>
            </div>
            <h3
              class="text-lg font-semibold text-gray-900 dark:text-white mb-2"
            >
              No hay campa√±as a√∫n
            </h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">
              Crea tu primera campa√±a para activar esta propuesta
            </p>
          </div>
        </div>

        <!-- Tab Content: An√°lisis de Viabilidad -->
        <div id="tab-viabilidad" class="tab-content hidden p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">
            An√°lisis de Viabilidad del Curso
          </h2>

          <!-- Score Principal -->
          <div
            class="p-6 bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-950/20 dark:to-purple-950/20 rounded-xl border border-blue-200 dark:border-blue-900/50 mb-6"
          >
            <div class="flex items-center justify-between mb-4">
              <div>
                <p
                  class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"
                >
                  Score de Viabilidad
                </p>
                <div class="flex items-baseline gap-3">
                  <p
                    id="scoreValue"
                    class="text-5xl font-bold text-gray-900 dark:text-white"
                  >
                    --
                  </p>
                  <span class="text-2xl text-gray-500 dark:text-gray-400"
                    >/100</span
                  >
                </div>
              </div>
              <div id="scoreIcon" class="text-6xl">
                <!-- Icono din√°mico -->
              </div>
            </div>

            <!-- Barra de progreso -->
            <div
              class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden mb-3"
            >
              <div
                id="scoreBar"
                class="h-4 rounded-full smooth-transition"
                style="width: 0%"
              >
              </div>
            </div>

            <p id="scoreLabel" class="text-sm font-medium"></p>
          </div>

          <!-- Desglose del Score -->
          <div class="mb-6">
            <h3
              class="text-lg font-semibold text-gray-900 dark:text-white mb-4"
            >
              Desglose del C√°lculo
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div
                class="p-4 bg-blue-50 dark:bg-blue-950/30 rounded-lg border border-blue-200 dark:border-blue-900/50"
              >
                <div class="flex items-center justify-between mb-2">
                  <span
                    class="text-sm font-medium text-blue-700 dark:text-blue-400"
                    >Alcance</span
                  >
                  <span
                    id="alcancePuntos"
                    class="text-lg font-bold text-gray-900 dark:text-white"
                    >-- pts</span
                  >
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-400">
                  Alcance total / 200
                </p>
              </div>

              <div
                class="p-4 bg-green-50 dark:bg-green-950/30 rounded-lg border border-green-200 dark:border-green-900/50"
              >
                <div class="flex items-center justify-between mb-2">
                  <span
                    class="text-sm font-medium text-green-700 dark:text-green-400"
                    >Engagement</span
                  >
                  <span
                    id="engagementPuntos"
                    class="text-lg font-bold text-gray-900 dark:text-white"
                    >-- pts</span
                  >
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-400">CTR √ó 8</p>
              </div>

              <div
                class="p-4 bg-purple-50 dark:bg-purple-950/30 rounded-lg border border-purple-200 dark:border-purple-900/50"
              >
                <div class="flex items-center justify-between mb-2">
                  <span
                    class="text-sm font-medium text-purple-700 dark:text-purple-400"
                    >Solicitudes</span
                  >
                  <span
                    id="solicitudesPuntos"
                    class="text-lg font-bold text-gray-900 dark:text-white"
                    >-- pts</span
                  >
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-400">
                  Pre-registros √ó 0.3
                </p>
              </div>

              <div
                class="p-4 bg-orange-50 dark:bg-orange-950/30 rounded-lg border border-orange-200 dark:border-orange-900/50"
              >
                <div class="flex items-center justify-between mb-2">
                  <span
                    class="text-sm font-medium text-orange-700 dark:text-orange-400"
                    >Comentarios</span
                  >
                  <span
                    id="comentariosPuntos"
                    class="text-lg font-bold text-gray-900 dark:text-white"
                    >-- pts</span
                  >
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-400">
                  Comentarios √ó 0.15
                </p>
              </div>
            </div>
          </div>

          <!-- Se√±ales de Compra -->
          <div class="mb-6">
            <h3
              class="text-lg font-semibold text-gray-900 dark:text-white mb-4"
            >
              Se√±ales de Inter√©s Real
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div
                class="p-4 bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-800"
              >
                <div class="flex items-center gap-3 mb-2">
                  <div
                    class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center"
                  >
                    <svg
                      class="w-5 h-5 text-blue-600 dark:text-blue-400"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                      ></path>
                    </svg>
                  </div>
                  <div>
                    <p
                      class="text-2xl font-bold text-gray-900 dark:text-white"
                      id="mensajesRecibidos"
                    >
                      --
                    </p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">
                      Mensajes recibidos
                    </p>
                  </div>
                </div>
              </div>

              <div
                class="p-4 bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-800"
              >
                <div class="flex items-center gap-3 mb-2">
                  <div
                    class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center"
                  >
                    <svg
                      class="w-5 h-5 text-green-600 dark:text-green-400"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      ></path>
                    </svg>
                  </div>
                  <div>
                    <p
                      class="text-2xl font-bold text-gray-900 dark:text-white"
                      id="preRegistros"
                    >
                      --
                    </p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">
                      Pre-registros
                    </p>
                  </div>
                </div>
              </div>

              <div
                class="p-4 bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-800"
              >
                <div class="flex items-center gap-3 mb-2">
                  <div
                    class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center"
                  >
                    <svg
                      class="w-5 h-5 text-purple-600 dark:text-purple-400"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                      ></path>
                    </svg>
                  </div>
                  <div>
                    <p
                      class="text-2xl font-bold text-gray-900 dark:text-white"
                      id="inscripcionesEsperadas"
                    >
                      --
                    </p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">
                      Inscripciones esperadas
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recomendaci√≥n Final -->
          <div id="recomendacionFinal" class="p-6 rounded-xl border-2">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        <!-- Tab Content: M√©tricas Detalladas -->
        <div id="tab-metricas" class="tab-content hidden p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">
            M√©tricas Completas de Campa√±as
          </h2>

          <!-- Stats Grid -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div
              class="p-6 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-950/30 dark:to-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-900/50"
            >
              <p
                class="text-sm font-medium text-blue-600 dark:text-blue-400 mb-2"
              >
                Total Alcance
              </p>
              <p
                id="metricaAlcance"
                class="text-3xl font-bold text-gray-900 dark:text-white"
              >
                --
              </p>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                Personas alcanzadas
              </p>
            </div>
            <div
              class="p-6 bg-gradient-to-br from-green-50 to-green-100 dark:from-green-950/30 dark:to-green-900/20 rounded-xl border border-green-200 dark:border-green-900/50"
            >
              <p
                class="text-sm font-medium text-green-600 dark:text-green-400 mb-2"
              >
                CTR Promedio
              </p>
              <p
                id="metricaEngagement"
                class="text-3xl font-bold text-gray-900 dark:text-white"
              >
                --%
              </p>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                Tasa de clics
              </p>
            </div>
            <div
              class="p-6 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-950/30 dark:to-purple-900/20 rounded-xl border border-purple-200 dark:border-purple-900/50"
            >
              <p
                class="text-sm font-medium text-purple-600 dark:text-purple-400 mb-2"
              >
                Pre-registros
              </p>
              <p
                id="metricaSolicitudes"
                class="text-3xl font-bold text-gray-900 dark:text-white"
              >
                --
              </p>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                Interesados
              </p>
            </div>
            <div
              class="p-6 bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-950/30 dark:to-orange-900/20 rounded-xl border border-orange-200 dark:border-orange-900/50"
            >
              <p
                class="text-sm font-medium text-orange-600 dark:text-orange-400 mb-2"
              >
                Interacciones
              </p>
              <p
                id="metricaCompartidos"
                class="text-3xl font-bold text-gray-900 dark:text-white"
              >
                --
              </p>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Total</p>
            </div>
          </div>

          <!-- Detalle adicional -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div
              class="p-6 bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800"
            >
              <h3 class="font-semibold text-gray-900 dark:text-white mb-4">
                Interacciones
              </h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 dark:text-gray-400"
                    >Likes</span
                  >
                  <span
                    id="metricaLikes"
                    class="text-sm font-bold text-gray-900 dark:text-white"
                    >--</span
                  >
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 dark:text-gray-400"
                    >Comentarios</span
                  >
                  <span
                    id="metricaComentarios"
                    class="text-sm font-bold text-gray-900 dark:text-white"
                    >--</span
                  >
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 dark:text-gray-400"
                    >Mensajes privados</span
                  >
                  <span
                    id="metricaMensajes"
                    class="text-sm font-bold text-gray-900 dark:text-white"
                    >--</span
                  >
                </div>
              </div>
            </div>

            <div
              class="p-6 bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800"
            >
              <h3 class="font-semibold text-gray-900 dark:text-white mb-4">
                Rendimiento
              </h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 dark:text-gray-400"
                    >Campa√±as</span
                  >
                  <span
                    id="metricaCampa√±as"
                    class="text-sm font-bold text-gray-900 dark:text-white"
                    >--</span
                  >
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 dark:text-gray-400"
                    >Intenci√≥n promedio</span
                  >
                  <span
                    id="metricaIntencion"
                    class="text-sm font-bold text-gray-900 dark:text-white"
                    >--%</span
                  >
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 dark:text-gray-400"
                    >CPA promedio</span
                  >
                  <span
                    id="metricaCPA"
                    class="text-sm font-bold text-gray-900 dark:text-white"
                    >$--</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Content: Recursos -->
        <div id="tab-recursos" class="tab-content hidden p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">
            Recursos y Materiales
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div
              class="p-6 bg-gray-50 dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 text-center hover:shadow-lg smooth-transition cursor-pointer group"
            >
              <div
                class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 smooth-transition"
              >
                <svg
                  class="w-8 h-8 text-blue-600 dark:text-blue-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                  ></path>
                </svg>
              </div>
              <h3 class="font-semibold text-gray-900 dark:text-white mb-2">
                Syllabus
              </h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Programa del curso
              </p>
              <button
                class="text-sm text-blue-600 dark:text-blue-400 hover:underline font-medium"
                >Ver documento</button
              >
            </div>

            <div
              class="p-6 bg-gray-50 dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 text-center hover:shadow-lg smooth-transition cursor-pointer group"
            >
              <div
                class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 smooth-transition"
              >
                <svg
                  class="w-8 h-8 text-green-600 dark:text-green-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
              </div>
              <h3 class="font-semibold text-gray-900 dark:text-white mb-2">
                Im√°genes
              </h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Assets visuales
              </p>
              <button
                class="text-sm text-green-600 dark:text-green-400 hover:underline font-medium"
                >Ver galer√≠a</button
              >
            </div>

            <div
              class="p-6 bg-gray-50 dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 text-center hover:shadow-lg smooth-transition cursor-pointer group"
            >
              <div
                class="w-16 h-16 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 smooth-transition"
              >
                <svg
                  class="w-8 h-8 text-purple-600 dark:text-purple-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                  ></path>
                </svg>
              </div>
              <h3 class="font-semibold text-gray-900 dark:text-white mb-2">
                Videos
              </h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Material audiovisual
              </p>
              <button
                class="text-sm text-purple-600 dark:text-purple-400 hover:underline font-medium"
                >Ver videos</button
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nueva Campa√±a -->
  <div
    id="modalNuevaCampa√±a"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4"
  >
    <div
      class="bg-white dark:bg-gray-950 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-gray-800"
    >
      <div
        class="p-6 border-b border-gray-200 dark:border-gray-800 sticky top-0 bg-white dark:bg-gray-950 z-10"
      >
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
              Nueva Campa√±a de Validaci√≥n
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
              Crea contenido educativo para medir el inter√©s del mercado
            </p>
          </div>
          <button
            id="btnCerrarModalCampa√±a"
            class="p-2 hover:bg-gray-100 dark:hover:bg-gray-900 rounded-lg smooth-transition"
          >
            <svg
              class="w-6 h-6 text-gray-600 dark:text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>

      <form id="formNuevaCampa√±a" class="p-6 space-y-6">
        <div>
          <label
            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
          >
            Nombre de la Campa√±a *
          </label>
          <input
            type="text"
            name="name"
            required
            placeholder="Ej: Contenido Educativo - Kotlin Tips"
            class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-white"
          />
        </div>

        <div>
          <label
            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
          >
            Objetivo *
          </label>
          <textarea
            name="objective"
            required
            rows="3"
            placeholder="Ej: Validar inter√©s del mercado en cursos de Kotlin avanzado"
            class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-white"
          ></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label
              class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
            >
              Fecha de Inicio *
            </label>
            <input
              type="date"
              name="start_date"
              required
              class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white"
            />
          </div>
          <div>
            <label
              class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
            >
              Fecha de Fin *
            </label>
            <input
              type="date"
              name="end_date"
              required
              class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white"
            />
          </div>
        </div>

        <!-- Info Box -->
        <div
          class="p-4 bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-900/50 rounded-lg"
        >
          <div class="flex items-start gap-3">
            <svg
              class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            <div>
              <p
                class="text-sm font-medium text-blue-900 dark:text-blue-300 mb-1"
              >
                üí° Primera campa√±a
              </p>
              <p class="text-xs text-blue-700 dark:text-blue-400">
                Al crear tu primera campa√±a, podr√°s empezar a crear posts y
                recopilar m√©tricas de inter√©s.
              </p>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div
          class="flex gap-3 pt-4 border-t border-gray-200 dark:border-gray-800"
        >
          <button
            type="button"
            id="btnCancelarCampa√±a"
            class="flex-1 px-6 py-3 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-gray-50 dark:hover:bg-gray-900 smooth-transition"
          >
            Cancelar
          </button>
          <button
            type="submit"
            id="btnSubmitCampa√±a"
            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-medium smooth-transition shadow-lg"
          >
            Crear Campa√±a
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    import {
      fetchProposalById,
      fetchCampaignsByProposal,
      fetchCampaignMetrics,
      fetchCampaignPosts,
      createCampaign,
      type ProposalForUI,
      type CampaignForUI,
      type CampaignMetricsForUI,
      type PostForUI,
    } from "../../../services/marketing";

    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    // ‚úÖ Obtener ID del atributo data
    const mainDiv = document.querySelector("[data-proposal-id]") as HTMLElement;
    const proposalId = parseInt(mainDiv?.dataset.proposalId || "0", 10);

    let propuestaData: ProposalForUI | null = null;
    let campa√±as: CampaignForUI[] = [];
    let metricasPorCampa√±a: Map<number, CampaignMetricsForUI> = new Map();
    let postsPorCampa√±a: Map<number, PostForUI[]> = new Map();

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================

    function mostrarError(mensaje: string) {
      document.getElementById("loadingState")?.classList.add("hidden");
      document.getElementById("mainContent")?.classList.add("hidden");
      const errorState = document.getElementById("errorState");
      const errorMessage = document.getElementById("errorMessage");
      if (errorState && errorMessage) {
        errorState.classList.remove("hidden");
        errorMessage.textContent = mensaje;
      }
    }

    function mostrarContenido() {
      document.getElementById("loadingState")?.classList.add("hidden");
      document.getElementById("errorState")?.classList.add("hidden");
      document.getElementById("mainContent")?.classList.remove("hidden");
    }

    function getEstadoBadgeHTML(estado: ProposalForUI["estado"]) {
      const configs = {
        borrador: {
          bg: "bg-gray-100 dark:bg-gray-800",
          text: "text-gray-700 dark:text-gray-400",
          border: "border-gray-300 dark:border-gray-700",
          icon: "üìù",
          label: "Borrador",
        },
        activa: {
          bg: "bg-green-50 dark:bg-green-950/30",
          text: "text-green-700 dark:text-green-400",
          border: "border-green-200 dark:border-green-900/50",
          icon: "üü¢",
          label: "Activa",
        },
        pausada: {
          bg: "bg-yellow-50 dark:bg-yellow-950/30",
          text: "text-yellow-700 dark:text-yellow-400",
          border: "border-yellow-200 dark:border-yellow-900/50",
          icon: "‚è∏Ô∏è",
          label: "Pausada",
        },
        aprobada: {
          bg: "bg-emerald-50 dark:bg-emerald-950/30",
          text: "text-emerald-700 dark:text-emerald-400",
          border: "border-emerald-200 dark:border-emerald-900/50",
          icon: "‚úÖ",
          label: "Aprobada",
        },
        rechazada: {
          bg: "bg-red-50 dark:bg-red-950/30",
          text: "text-red-700 dark:text-red-400",
          border: "border-red-200 dark:border-red-900/50",
          icon: "‚ùå",
          label: "Rechazada",
        },
      };

      const config = configs[estado];
      return `<span class="px-3 py-1 ${config.bg} ${config.text} border ${config.border} rounded-full text-sm font-medium">${config.icon} ${config.label}</span>`;
    }

    function getPrioridadBadgeHTML(prioridad: ProposalForUI["prioridad"]) {
      const configs = {
        alta: {
          bg: "bg-red-50 dark:bg-red-950/30",
          text: "text-red-700 dark:text-red-400",
          border: "border-red-200 dark:border-red-900/50",
          icon: "üî¥",
          label: "Prioridad Alta",
        },
        media: {
          bg: "bg-yellow-50 dark:bg-yellow-950/30",
          text: "text-yellow-700 dark:text-yellow-400",
          border: "border-yellow-200 dark:border-yellow-900/50",
          icon: "üü°",
          label: "Prioridad Media",
        },
        baja: {
          bg: "bg-green-50 dark:bg-green-950/30",
          text: "text-green-700 dark:text-green-400",
          border: "border-green-200 dark:border-green-900/50",
          icon: "üü¢",
          label: "Prioridad Baja",
        },
      };

      const config = configs[prioridad];
      return `<span class="px-3 py-1 ${config.bg} ${config.text} border ${config.border} rounded-full text-sm font-medium">${config.icon} ${config.label}</span>`;
    }

    // ============================================
    // RENDERIZAR PROPUESTA
    // ============================================

    function renderPropuesta(propuesta: ProposalForUI) {
      // Breadcrumb
      const breadcrumb = document.getElementById("breadcrumbTitle");
      if (breadcrumb) breadcrumb.textContent = propuesta.tema;

      // T√≠tulo
      const titulo = document.getElementById("propuestaTitulo");
      if (titulo) titulo.textContent = propuesta.tema;

      // Estado
      const estadoBadge = document.getElementById("propuestaEstadoBadge");
      if (estadoBadge)
        estadoBadge.outerHTML = getEstadoBadgeHTML(propuesta.estado);

      // Prioridad
      const prioridadBadge = document.getElementById("propuestaPrioridadBadge");
      if (prioridadBadge)
        prioridadBadge.outerHTML = getPrioridadBadgeHTML(propuesta.prioridad);

      // Descripci√≥n
      const descripcion = document.getElementById("propuestaDescripcion");
      if (descripcion) descripcion.textContent = propuesta.descripcion;

      // Informaci√≥n b√°sica
      const info = document.getElementById("propuestaInfo");
      if (info) {
        info.innerHTML = `
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            <span class="text-gray-600 dark:text-gray-400">${propuesta.departamento}</span>
          </div>
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span class="text-gray-600 dark:text-gray-400">Creado: ${new Date(propuesta.fecha).toLocaleDateString("es-ES", { day: "numeric", month: "long", year: "numeric" })}</span>
          </div>
        `;
      }

      // P√∫blico objetivo
      const publico = document.getElementById("propuestaPublico");
      if (publico) {
        publico.innerHTML = propuesta.publico
          .map(
            (p) =>
              `<span class="px-3 py-1 bg-blue-50 dark:bg-blue-950/30 text-blue-700 dark:text-blue-400 rounded-full text-sm">${p}</span>`,
          )
          .join("");
      }
    }

    // ============================================
    // RENDERIZAR CAMPA√ëAS
    // ============================================

    async function renderCampa√±as() {
      const container = document.getElementById("campa√±asList");
      const emptyState = document.getElementById("emptyCampa√±as");

      if (!container || !emptyState) return;

      if (campa√±as.length === 0) {
        container.classList.add("hidden");
        emptyState.classList.remove("hidden");
        return;
      }

      container.classList.remove("hidden");
      emptyState.classList.add("hidden");

      // Cargar m√©tricas y posts para cada campa√±a
      for (const campa√±a of campa√±as) {
        if (!metricasPorCampa√±a.has(campa√±a.id)) {
          try {
            const metricas = await fetchCampaignMetrics(campa√±a.id);
            metricasPorCampa√±a.set(campa√±a.id, metricas);
          } catch (error) {
            console.error(
              `Error loading metrics for campaign ${campa√±a.id}:`,
              error,
            );
          }
        }

        if (!postsPorCampa√±a.has(campa√±a.id)) {
          try {
            const posts = await fetchCampaignPosts(campa√±a.id);
            postsPorCampa√±a.set(campa√±a.id, posts);
          } catch (error) {
            console.error(
              `Error loading posts for campaign ${campa√±a.id}:`,
              error,
            );
          }
        }
      }

      // Renderizar
      container.innerHTML = campa√±as
        .map((c) => {
          const metricas = metricasPorCampa√±a.get(c.id);
          const posts = postsPorCampa√±a.get(c.id) || [];
          const estadoColor =
            c.estado === "activa"
              ? "bg-green-50 dark:bg-green-950/30 text-green-700 dark:text-green-400 border-green-200 dark:border-green-900/50"
              : "bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 border-gray-200 dark:border-gray-700";

          // Extraer plataformas √∫nicas de los posts
          const plataformas = [...new Set(posts.map((p) => p.plataforma))];
          const plataformasHTML = plataformas
            .map((plat) => {
              const icon = plat.toLowerCase().includes("instagram")
                ? "üì∏"
                : plat.toLowerCase().includes("facebook")
                  ? "f"
                  : plat.toLowerCase().includes("tiktok")
                    ? "üéµ"
                    : "üì±";
              return `<span class="w-6 h-6 bg-blue-600 rounded flex items-center justify-center text-white text-xs font-bold">${icon}</span>`;
            })
            .join("");

          const videos = posts.filter((p) => p.tipo === "video").length;
          const imagenes = posts.filter((p) => p.tipo === "image").length;

          return `
          <div class="p-6 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl hover:shadow-lg smooth-transition group">
            <div class="flex items-start justify-between mb-4">
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 smooth-transition">
                  ${c.nombre}
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">${c.objetivo}</p>
                <div class="flex items-center gap-2 mb-3">
                  ${plataformasHTML || '<span class="text-xs text-gray-400">Sin posts a√∫n</span>'}
                </div>
              </div>
              <span class="px-3 py-1 ${estadoColor} border rounded-full text-xs font-medium capitalize">
                ${c.estado === "activa" ? "üü¢ Activa" : "‚èπÔ∏è Finalizada"}
              </span>
            </div>

            <div class="grid grid-cols-3 gap-4 mb-4">
              <div class="text-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                <p class="text-2xl font-bold text-gray-900 dark:text-white">${posts.length}</p>
                <p class="text-xs text-gray-600 dark:text-gray-400">Posts</p>
              </div>
              <div class="text-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                <p class="text-2xl font-bold text-gray-900 dark:text-white">${videos}</p>
                <p class="text-xs text-gray-600 dark:text-gray-400">Videos</p>
              </div>
              <div class="text-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                <p class="text-2xl font-bold text-gray-900 dark:text-white">${metricas ? (metricas.totalReach / 1000).toFixed(1) + "K" : "--"}</p>
                <p class="text-xs text-gray-600 dark:text-gray-400">Alcance</p>
              </div>
            </div>

            <div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-400 mb-4">
              <span>${new Date(c.inicio).toLocaleDateString("es-ES", { day: "numeric", month: "short" })}</span>
              <span>‚Üí</span>
              <span>${new Date(c.fin).toLocaleDateString("es-ES", { day: "numeric", month: "short" })}</span>
            </div>

            <div class="flex gap-2">
              <div class="flex gap-2">
                <a href="/marketing/campa√±as/${c.id}" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium smooth-transition text-center">
                  Ver Detalles
                </a>
              </div>
              <button class="px-4 py-2 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-900 smooth-transition">
                Editar
              </button>
            </div>
          </div>
        `;
        })
        .join("");
    }

    // ============================================
    // ACTUALIZAR TABS CON M√âTRICAS REALES
    // ============================================

    function actualizarMetricas() {
      // Agregar m√©tricas de todas las campa√±as
      let totalReach = 0;
      let totalInteractions = 0;
      let totalLikes = 0;
      let totalComments = 0;
      let totalMessages = 0;
      let totalPreRegistrations = 0;
      let sumCtr = 0;
      let sumIntention = 0;
      let sumCpa = 0;
      let expectedEnrollments = 0;
      let count = 0;

      metricasPorCampa√±a.forEach((m) => {
        totalReach += m.totalReach;
        totalInteractions += m.totalInteractions;
        totalLikes += m.totalLikes;
        totalComments += m.totalComments;
        count++;
      });

      const avgCtr = count > 0 ? sumCtr / count : 0;
      const avgIntention = count > 0 ? sumIntention / count : 0;
      const avgCpa = count > 0 ? sumCpa / count : 0;

      // Quick Metrics (header)
      if (propuestaData && propuestaData.estado !== "borrador" && count > 0) {
        const quickMetricsContainer = document.getElementById(
          "quickMetricsContainer",
        );
        const quickMetrics = document.getElementById("quickMetrics");
        if (quickMetricsContainer && quickMetrics) {
          quickMetricsContainer.classList.remove("hidden");

          // Calcular score
          const score = Math.min(
            Math.round(
              totalReach / 200 +
                avgCtr * 8 +
                totalPreRegistrations * 0.3 +
                totalComments * 0.15,
            ),
            100,
          );

          const getViabColor = (s: number) => {
            if (s >= 85) return "text-green-600 dark:text-green-400";
            if (s >= 65) return "text-yellow-600 dark:text-yellow-400";
            if (s >= 40) return "text-orange-600 dark:text-orange-400";
            return "text-red-600 dark:text-red-400";
          };

          quickMetrics.innerHTML = `
            <div class="text-center">
              <p class="text-sm text-gray-600 dark:text-gray-400">Alcance</p>
              <p class="text-2xl font-bold text-gray-900 dark:text-white">${(totalReach / 1000).toFixed(1)}K</p>
            </div>
            <div class="text-center">
              <p class="text-sm text-gray-600 dark:text-gray-400">CTR Promedio</p>
              <p class="text-2xl font-bold text-gray-900 dark:text-white">${avgCtr.toFixed(1)}%</p>
            </div>
            <div class="text-center">
              <p class="text-sm text-gray-600 dark:text-gray-400">Score</p>
              <p class="text-2xl font-bold ${getViabColor(score)}">${score}/100</p>
            </div>
            <div class="text-center">
              <p class="text-sm text-gray-600 dark:text-gray-400">Pre-registros</p>
              <p class="text-2xl font-bold text-gray-900 dark:text-white">${totalPreRegistrations}</p>
            </div>
          `;
        }
      }

      // Tab Viabilidad
      if (count > 0) {
        const score = Math.min(
          Math.round(
            totalReach / 200 +
              avgCtr * 8 +
              totalPreRegistrations * 0.3 +
              totalComments * 0.15,
          ),
          100,
        );

        const getViabilidadConfig = (s: number) => {
          if (s >= 85)
            return {
              label: "Muy Viable - Listo para Aprobar",
              icon: "üü¢",
              color: "text-green-600 dark:text-green-400",
              bg: "bg-green-50 dark:bg-green-950/30",
              border: "border-green-500",
              barColor: "bg-gradient-to-r from-green-500 to-emerald-500",
            };
          if (s >= 65)
            return {
              label: "Viable - Buen Potencial",
              icon: "üü°",
              color: "text-yellow-600 dark:text-yellow-400",
              bg: "bg-yellow-50 dark:bg-yellow-950/30",
              border: "border-yellow-500",
              barColor: "bg-gradient-to-r from-yellow-500 to-orange-500",
            };
          if (s >= 40)
            return {
              label: "Dudoso - Necesita M√°s Validaci√≥n",
              icon: "üü†",
              color: "text-orange-600 dark:text-orange-400",
              bg: "bg-orange-50 dark:bg-orange-950/30",
              border: "border-orange-500",
              barColor: "bg-gradient-to-r from-orange-500 to-red-500",
            };
          return {
            label: "No Viable - Bajo Inter√©s",
            icon: "üî¥",
            color: "text-red-600 dark:text-red-400",
            bg: "bg-red-50 dark:bg-red-950/30",
            border: "border-red-500",
            barColor: "bg-gradient-to-r from-red-500 to-red-600",
          };
        };

        const viab = getViabilidadConfig(score);

        // Score principal
        const scoreValue = document.getElementById("scoreValue");
        const scoreIcon = document.getElementById("scoreIcon");
        const scoreLabel = document.getElementById("scoreLabel");
        const scoreBar = document.getElementById("scoreBar");

        if (scoreValue) scoreValue.textContent = String(score);
        if (scoreIcon) scoreIcon.textContent = viab.icon;
        if (scoreLabel) {
          scoreLabel.textContent = viab.label;
          scoreLabel.className = `text-sm font-medium ${viab.color}`;
        }
        if (scoreBar) {
          scoreBar.className = `h-4 rounded-full smooth-transition ${viab.barColor}`;
          scoreBar.style.width = `${score}%`;
        }

        // Desglose
        const alcancePuntos = document.getElementById("alcancePuntos");
        const engagementPuntos = document.getElementById("engagementPuntos");
        const solicitudesPuntos = document.getElementById("solicitudesPuntos");
        const comentariosPuntos = document.getElementById("comentariosPuntos");

        if (alcancePuntos)
          alcancePuntos.textContent = Math.round(totalReach / 200) + " pts";
        if (engagementPuntos)
          engagementPuntos.textContent = Math.round(avgCtr * 8) + " pts";
        if (solicitudesPuntos)
          solicitudesPuntos.textContent =
            Math.round(totalPreRegistrations * 0.3) + " pts";
        if (comentariosPuntos)
          comentariosPuntos.textContent =
            Math.round(totalComments * 0.15) + " pts";

        // Se√±ales
        const mensajesRecibidos = document.getElementById("mensajesRecibidos");
        const preRegistros = document.getElementById("preRegistros");
        const inscripcionesEsperadas = document.getElementById(
          "inscripcionesEsperadas",
        );

        if (mensajesRecibidos)
          mensajesRecibidos.textContent = String(totalMessages);
        if (preRegistros)
          preRegistros.textContent = String(totalPreRegistrations);
        if (inscripcionesEsperadas)
          inscripcionesEsperadas.textContent = String(expectedEnrollments);

        // Recomendaci√≥n
        const recomendacion = document.getElementById("recomendacionFinal");
        if (recomendacion) {
          if (score >= 85) {
            recomendacion.className = `p-6 rounded-xl border-2 ${viab.border} ${viab.bg}`;
            recomendacion.innerHTML = `
              <div class="flex items-start gap-4">
                <div class="text-5xl">${viab.icon}</div>
                <div>
                  <h4 class="text-lg font-bold ${viab.color} mb-2">‚úÖ Listo para Aprobar</h4>
                  <p class="text-sm text-gray-700 dark:text-gray-300 mb-3">
                    Esta propuesta muestra se√±ales muy positivas de inter√©s del mercado. El engagement y las solicitudes de informaci√≥n indican una demanda real.
                  </p>
                  <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                    <li>‚úì Alcance superior al promedio</li>
                    <li>‚úì Alta tasa de CTR (${avgCtr.toFixed(1)}%)</li>
                    <li>‚úì ${totalPreRegistrations} pre-registros</li>
                  </ul>
                </div>
              </div>
            `;
          } else if (score >= 65) {
            recomendacion.className = `p-6 rounded-xl border-2 ${viab.border} ${viab.bg}`;
            recomendacion.innerHTML = `
              <div class="flex items-start gap-4">
                <div class="text-5xl">${viab.icon}</div>
                <div>
                  <h4 class="text-lg font-bold ${viab.color} mb-2">üéØ Buen Potencial</h4>
                  <p class="text-sm text-gray-700 dark:text-gray-300 mb-3">
                    La propuesta muestra potencial, pero se recomienda validar un poco m√°s antes de aprobar.
                  </p>
                </div>
              </div>
            `;
          } else {
            recomendacion.className = `p-6 rounded-xl border-2 ${viab.border} ${viab.bg}`;
            recomendacion.innerHTML = `
              <div class="flex items-start gap-4">
                <div class="text-5xl">${viab.icon}</div>
                <div>
                  <h4 class="text-lg font-bold ${viab.color} mb-2">‚ö†Ô∏è Necesita M√°s Validaci√≥n</h4>
                  <p class="text-sm text-gray-700 dark:text-gray-300 mb-3">
                    El inter√©s actual es bajo. Se recomienda ajustar la estrategia de contenido.
                  </p>
                </div>
              </div>
            `;
          }
        }
      }

      // Tab M√©tricas Detalladas
      const metricaAlcance = document.getElementById("metricaAlcance");
      const metricaEngagement = document.getElementById("metricaEngagement");
      const metricaSolicitudes = document.getElementById("metricaSolicitudes");
      const metricaCompartidos = document.getElementById("metricaCompartidos");
      const metricaLikes = document.getElementById("metricaLikes");
      const metricaComentarios = document.getElementById("metricaComentarios");
      const metricaMensajes = document.getElementById("metricaMensajes");
      const metricaCampa√±as = document.getElementById("metricaCampa√±as");
      const metricaIntencion = document.getElementById("metricaIntencion");
      const metricaCPA = document.getElementById("metricaCPA");

      if (metricaAlcance)
        metricaAlcance.textContent = (totalReach / 1000).toFixed(1) + "K";
      if (metricaEngagement)
        metricaEngagement.textContent = avgCtr.toFixed(1) + "%";
      if (metricaSolicitudes)
        metricaSolicitudes.textContent = String(totalPreRegistrations);
      if (metricaCompartidos)
        metricaCompartidos.textContent = String(totalInteractions);
      if (metricaLikes) metricaLikes.textContent = String(totalLikes);
      if (metricaComentarios)
        metricaComentarios.textContent = String(totalComments);
      if (metricaMensajes) metricaMensajes.textContent = String(totalMessages);
      if (metricaCampa√±as)
        metricaCampa√±as.textContent = String(campa√±as.length);
      if (metricaIntencion)
        metricaIntencion.textContent = avgIntention.toFixed(1) + "%";
      if (metricaCPA) metricaCPA.textContent = "$" + avgCpa.toFixed(2);
    }

    // ============================================
    // INICIALIZACI√ìN
    // ============================================

    document.addEventListener("DOMContentLoaded", async () => {
      console.log("[ID Page] Loading proposal:", proposalId);

      try {
        // 1. Cargar propuesta
        propuestaData = await fetchProposalById(proposalId);
        console.log("[ID Page] Proposal loaded:", propuestaData);

        // 2. Renderizar propuesta
        renderPropuesta(propuestaData);

        // 3. Cargar campa√±as
        campa√±as = await fetchCampaignsByProposal(proposalId);
        console.log("[ID Page] Campaigns loaded:", campa√±as.length);

        // 4. Renderizar campa√±as
        await renderCampa√±as();

        // 5. Actualizar m√©tricas
        actualizarMetricas();

        // 6. Mostrar contenido
        mostrarContenido();
      } catch (error) {
        console.error("[ID Page] Error loading data:", error);
        mostrarError(
          error instanceof Error ? error.message : "Error desconocido",
        );
      }

      // ============================================
      // TABS
      // ============================================

      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.getAttribute("data-tab");

          document.querySelectorAll(".tab-btn").forEach((b) => {
            b.classList.remove(
              "bg-blue-50",
              "dark:bg-blue-950/30",
              "text-blue-600",
              "dark:text-blue-400",
            );
            b.classList.add("text-gray-600", "dark:text-gray-400");
          });
          btn.classList.add(
            "bg-blue-50",
            "dark:bg-blue-950/30",
            "text-blue-600",
            "dark:text-blue-400",
          );
          btn.classList.remove("text-gray-600", "dark:text-gray-400");

          document.querySelectorAll(".tab-content").forEach((content) => {
            content.classList.add("hidden");
          });
          document.getElementById(`tab-${tab}`)?.classList.remove("hidden");
        });
      });

      // ============================================
      // MODAL NUEVA CAMPA√ëA
      // ============================================

      const modal = document.getElementById("modalNuevaCampa√±a");
      const btnAbrir = document.getElementById("btnNuevaCampa√±a");
      const btnCerrar = document.getElementById("btnCerrarModalCampa√±a");
      const btnCancelar = document.getElementById("btnCancelarCampa√±a");

      btnAbrir?.addEventListener("click", () => {
        modal?.classList.remove("hidden");
        modal?.classList.add("flex");
      });

      [btnCerrar, btnCancelar].forEach((btn) => {
        btn?.addEventListener("click", () => {
          modal?.classList.add("hidden");
          modal?.classList.remove("flex");
        });
      });

      modal?.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }
      });

      // ============================================
      // FORM SUBMIT
      // ============================================

      const form = document.getElementById(
        "formNuevaCampa√±a",
      ) as HTMLFormElement;
      form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const btnSubmit = document.getElementById(
          "btnSubmitCampa√±a",
        ) as HTMLButtonElement;
        const originalText = btnSubmit.textContent;

        btnSubmit.disabled = true;
        btnSubmit.textContent = "Creando...";

        try {
          const nuevaCampa√±a = await createCampaign({
            name: formData.get("name") as string,
            objective: formData.get("objective") as string,
            start_date: formData.get("start_date") as string,
            end_date: formData.get("end_date") as string,
            proposal_id: proposalId,
          });

          console.log("[ID Page] Campaign created:", nuevaCampa√±a);

          // Agregar a la lista
          campa√±as.unshift(nuevaCampa√±a);

          // Re-renderizar
          await renderCampa√±as();
          actualizarMetricas();

          // Cerrar modal
          modal?.classList.add("hidden");
          modal?.classList.remove("flex");
          form.reset();

          alert("‚úÖ ¬°Campa√±a creada con √©xito!");
        } catch (error) {
          console.error("[ID Page] Error creating campaign:", error);
          alert(
            `‚ùå Error al crear la campa√±a:\n\n${error instanceof Error ? error.message : "Error desconocido"}`,
          );
        } finally {
          btnSubmit.disabled = false;
          btnSubmit.textContent = originalText;
        }
      });
    });
  </script>
</Layout>
