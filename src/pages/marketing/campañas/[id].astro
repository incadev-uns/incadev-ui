---
import Layout from "../../../layouts/MarketingLayout.astro";

export const prerender = false;

const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/marketing/campa√±as");
}

const mockTitle = "Detalle de Campa√±a";
---

<Layout title={mockTitle}>
    <div class="space-y-6" data-campaign-id={id}>
        <!-- Back Button + Header -->
        <div class="flex items-center gap-4 mb-6">
            <a
                href="/marketing/campa√±as"
                class="p-2 hover:bg-gray-100 dark:hover:bg-gray-900 rounded-lg smooth-transition"
            >Back</a>
            <!-- Campaign level actions are rendered per-post below; avoid referencing `p` here which is only defined per-post in the list -->
        </div>
        <div class="flex-1">
            <h1
                id="campaignTitle"
                class="text-3xl font-bold text-gray-900 dark:text-white mb-2"
            >
                Cargando...
            </h1>
            <p id="campaignSubtitle" class="text-gray-600 dark:text-gray-400">
                Gestiona las publicaciones de esta campa√±a
            </p>
        </div>
        <button
            id="btnNuevoPost"
            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-medium smooth-transition flex items-center gap-2 shadow-lg hover:shadow-xl"
        >
            <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"></path>
            </svg>
            Nueva Publicaci√≥n
        </button>
        <button
            id="btnPublishSelected"
            disabled
            title="Publicar la publicaci√≥n seleccionada (debe estar en modo edici√≥n)"
            class="px-4 py-2 ml-2 border border-green-600 text-green-600 dark:text-green-400 bg-white dark:bg-gray-950 rounded-lg text-sm font-medium hover:bg-green-50 dark:hover:bg-green-950/30 disabled:opacity-50 disabled:cursor-not-allowed"
        >
            üöÄ Publicar Seleccionado
        </button>
    </div>

    <!-- Campaign Info Card -->
    <div
        id="campaignInfoCard"
        class="p-6 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl"
    >
        <!-- Se llenar√° din√°micamente -->
    </div>

    <!-- M√©tricas Globales -->
    <div
        id="metricsCard"
        class="p-6 bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-950/30 dark:to-purple-950/30 border border-blue-200 dark:border-blue-900/50 rounded-xl"
    >
        <h2
            class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2"
        >
            <svg
                class="w-6 h-6 text-blue-600 dark:text-blue-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                ></path>
            </svg>
            M√©tricas Globales de la Campa√±a
        </h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center">
                <p
                    id="metric-reach"
                    class="text-3xl font-bold text-blue-600 dark:text-blue-400"
                >
                    0
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    Alcance Total
                </p>
            </div>
            <div class="text-center">
                <p
                    id="metric-interactions"
                    class="text-3xl font-bold text-purple-600 dark:text-purple-400"
                >
                    0
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    Interacciones
                </p>
            </div>
            <div class="text-center">
                <p
                    id="metric-prereg"
                    class="text-3xl font-bold text-green-600 dark:text-green-400"
                >
                    0
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    Pre-inscripciones
                </p>
            </div>
            <div class="text-center">
                <p
                    id="metric-enrollments"
                    class="text-3xl font-bold text-emerald-600 dark:text-emerald-400"
                >
                    0
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    Inscripciones Esperadas
                </p>
            </div>
        </div>
    </div>

    <!-- Stats + Filters -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <button
            class="filter-btn p-4 bg-white dark:bg-gray-950 border-2 border-blue-500 dark:border-blue-500 rounded-lg smooth-transition hover:shadow-md"
            data-filter="todos"
        >
            <div class="text-center">
                <p
                    id="stat-todos"
                    class="text-2xl font-bold text-gray-900 dark:text-white"
                >
                    0
                </p>
                <p
                    class="text-xs text-gray-600 dark:text-gray-400 mt-1 font-medium"
                >
                    Todas
                </p>
            </div>
        </button>

        <button
            class="filter-btn p-4 bg-white dark:bg-gray-950 border-2 border-gray-200 dark:border-gray-800 hover:border-gray-500 dark:hover:border-gray-500 rounded-lg smooth-transition hover:shadow-md"
            data-filter="draft"
        >
            <div class="text-center">
                <p
                    id="stat-draft"
                    class="text-2xl font-bold text-gray-600 dark:text-gray-400"
                >
                    0
                </p>
                <p
                    class="text-xs text-gray-600 dark:text-gray-400 mt-1 font-medium"
                >
                    Borradores
                </p>
            </div>
        </button>

        <button
            class="filter-btn p-4 bg-white dark:bg-gray-950 border-2 border-gray-200 dark:border-gray-800 hover:border-yellow-500 dark:hover:border-yellow-500 rounded-lg smooth-transition hover:shadow-md"
            data-filter="scheduled"
        >
            <div class="text-center">
                <p
                    id="stat-scheduled"
                    class="text-2xl font-bold text-yellow-600 dark:text-yellow-400"
                >
                    0
                </p>
                <p
                    class="text-xs text-gray-600 dark:text-gray-400 mt-1 font-medium"
                >
                    Programadas
                </p>
            </div>
        </button>

        <button
            class="filter-btn p-4 bg-white dark:bg-gray-950 border-2 border-gray-200 dark:border-gray-800 hover:border-green-500 dark:hover:border-green-500 rounded-lg smooth-transition hover:shadow-md"
            data-filter="published"
        >
            <div class="text-center">
                <p
                    id="stat-published"
                    class="text-2xl font-bold text-green-600 dark:text-green-400"
                >
                    0
                </p>
                <p
                    class="text-xs text-gray-600 dark:text-gray-400 mt-1 font-medium"
                >
                    Publicadas
                </p>
            </div>
        </button>
    </div>

    <!-- Search Bar -->
    <div class="flex gap-4">
        <div class="flex-1">
            <div class="relative">
                <svg
                    class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input
                    id="searchInput"
                    type="text"
                    placeholder="Buscar publicaciones por t√≠tulo..."
                    class="w-full pl-12 pr-4 py-3 bg-white dark:bg-gray-950 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                />
            </div>
        </div>

        <button
            id="btnLimpiarFiltros"
            class="px-6 py-3 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-900 smooth-transition font-medium"
        >
            Limpiar
        </button>
    </div>

    <!-- Posts List -->
    <div
        id="postsList"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
    >
        <!-- Los posts se cargar√°n aqu√≠ din√°micamente -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden text-center py-12">
        <div
            class="w-20 h-20 bg-gray-100 dark:bg-gray-900 rounded-full flex items-center justify-center mx-auto mb-4"
        >
            <svg
                class="w-10 h-10 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"
                ></path>
            </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            No hay publicaciones
        </h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
            Crea tu primera publicaci√≥n para esta campa√±a
        </p>
    </div>
</Layout>

<!-- Modal Nueva/Editar Publicaci√≥n -->
<div
    id="modalPost"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4"
>
    <div
        class="bg-white dark:bg-gray-950 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-gray-800"
    >
        <div
            class="p-6 border-b border-gray-200 dark:border-gray-800 sticky top-0 bg-white dark:bg-gray-950 z-10"
        >
            <div class="flex items-center justify-between">
                <h2
                    id="modalTitle"
                    class="text-2xl font-bold text-gray-900 dark:text-white"
                >
                    Nueva Publicaci√≥n
                </h2>
                <button
                    id="btnCerrarModal"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-gray-900 rounded-lg smooth-transition"
                >
                    <svg
                        class="w-6 h-6 text-gray-600 dark:text-gray-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <form id="formPost" class="p-6 space-y-6">
            <input type="hidden" id="postId" />
            <input type="hidden" id="campaignId" />

            <!-- T√≠tulo -->
            <div>
                <label
                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                >
                    T√≠tulo *
                </label>
                <input
                    type="text"
                    id="postTitle"
                    required
                    placeholder="Ej: Promoci√≥n Black Friday 2025"
                    class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-white"
                />
            </div>
            <!-- Plataforma y Tipo -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label
                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                    >
                        Plataforma *
                    </label>
                    <select
                        id="postPlatform"
                        required
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white"
                    >
                        <option value="">Seleccionar...</option>
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                    </select>
                </div>
                <div>
                    <label
                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                    >
                        Tipo de Contenido *
                    </label>
                    <select
                        id="postContentType"
                        required
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white"
                    >
                        <option value="">Seleccionar...</option>
                        <option value="image">Imagen</option>
                        <option value="video">Video</option>
                        <option value="text">Texto</option>
                    </select>
                </div>
            </div>
                        <!-- Link URL -->
            <div>
                <label
                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                >
                    URL de Enlace *
                </label>
                <input
                    type="url"
                    id="postLinkUrl"
                    required
                    placeholder="https://ejemplo.com/landing"
                    class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-white"
                />
            </div>
            <!-- Generaci√≥n con IA (prompt-first) -->
            <div class="pt-4 border-t border-gray-200 dark:border-gray-800">
                <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">Generar con IA (prompt)</label>
                <div class="flex gap-2">
                    <input id="postPrompt" type="text" placeholder="Describe la publicaci√≥n, p.ej. Oferta 2x1 en sandalias" class="flex-1 px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500" />
                    <button id="btnGenerateAI" type="button" class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500">‚ú® Generar</button>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">El generador crear√° texto sugerido e imagen temporal que podr√°s revisar antes de guardar.</p>
            </div>



            <!-- Contenido -->
            <div>
                <label
                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                >
                    Contenido *
                </label>
                <textarea
                    id="postContent"
                    required
                    rows="4"
                    placeholder="Escribe el texto de la publicaci√≥n..."
                    class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-white"
                ></textarea>
            </div>

            <!-- Imagen Path -->
            <div>
                <label
                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                >
                    Ruta de Imagen *
                </label>
                <input
                    type="text"
                    id="postImagePath"
                    placeholder="uploads/posts/mi-imagen.jpg"
                    class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-white"
                />
                <input type="hidden" id="postImageUrl" />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Por ahora ingresa la ruta manualmente. Pr√≥ximamente con
                    Gemini AI
                </p>
            </div>



            <!-- Estado y Fecha -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label
                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                    >
                        Estado *
                    </label>
                    <select
                        id="postStatus"
                        required
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white"
                    >
                        <option value="draft">Borrador</option>
                        <option value="scheduled">Programado</option>
                        <option value="published">Publicado</option>
                    </select>
                </div>
                <div>
                    <label
                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                    >
                        Fecha Programada
                    </label>
                    <input
                        type="datetime-local"
                        id="postScheduledAt"
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white"
                    />
                </div>
            </div>

            <!-- Buttons -->
            <div
                class="flex gap-3 pt-4 border-t border-gray-200 dark:border-gray-800"
            >
                <button
                    type="button"
                    id="btnCancelarModal"
                    class="flex-1 px-6 py-3 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-gray-50 dark:hover:bg-gray-900 smooth-transition"
                >
                    Cancelar
                </button>
                <button
                    type="submit"
                    id="btnSubmitForm"
                    class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-medium smooth-transition shadow-lg"
                >
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Ver M√©tricas -->
<div
    id="modalMetrics"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4"
>
    <div
        class="bg-white dark:bg-gray-950 rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-gray-800"
    >
        <div
            class="p-6 border-b border-gray-200 dark:border-gray-800 sticky top-0 bg-white dark:bg-gray-950 z-10"
        >
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                    üìä M√©tricas de Publicaci√≥n
                </h2>
                <button
                    id="btnCerrarMetrics"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-gray-900 rounded-lg smooth-transition"
                >
                    <svg
                        class="w-6 h-6 text-gray-600 dark:text-gray-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="metricsContent" class="p-6">
            <!-- Se llenar√° din√°micamente -->
        </div>
    </div>
</div>

<script>
    import {
        fetchCampaignById,
        fetchCampaignPosts,
        fetchCampaignMetrics,
        createPost,
        publishPost,
        generateDraft,
        updatePost,
        deletePost,
        fetchPostMetrics,
        type CampaignForUI,
        type PostForUI,
        type CreatePostDTO,
        type UpdatePostDTO,
    } from "../../../services/marketing/index";

                // ============================================
    // VARIABLES GLOBALES
    // ============================================
    const mainDiv = document.querySelector("[data-campaign-id]") as HTMLElement;
    const campaignId = parseInt(mainDiv?.dataset.campaignId || "0", 10);

    let campaignData: CampaignForUI | null = null;
    let posts: PostForUI[] = [];
    let editingPostId: number | null = null;

    // ============================================
    // CONFIGURACI√ìN
    // ============================================
    const estadoConfig = {
        draft: {
            label: "Borrador",
            bg: "bg-gray-100 dark:bg-gray-800",
            text: "text-gray-700 dark:text-gray-400",
            icon: "üìù",
        },
        scheduled: {
            label: "Programado",
            bg: "bg-yellow-50 dark:bg-yellow-950/30",
            text: "text-yellow-700 dark:text-yellow-400",
            icon: "üìÖ",
        },
        published: {
            label: "Publicado",
            bg: "bg-green-50 dark:bg-green-950/30",
            text: "text-green-700 dark:text-green-400",
            icon: "‚úÖ",
        },
    };

    const plataformaConfig = {
        facebook: { icon: "üìò", color: "text-blue-600" },
        instagram: { icon: "üì∑", color: "text-pink-600" },
        tiktok: { icon: "üéµ", color: "text-gray-900" },
    };

    // ============================================
    // CARGAR DATOS INICIALES
    // ============================================
    async function loadCampaignData() {
        try {
            console.log("[Campaign Detail] Loading campaign:", campaignId);

            // Cargar campa√±a
            campaignData = await fetchCampaignById(campaignId);

            // Actualizar header
            document.getElementById("campaignTitle")!.textContent =
                campaignData.nombre;
            document.getElementById("campaignSubtitle")!.textContent =
                `${campaignData.objetivo}`;

            // Renderizar info card
            renderCampaignInfo();

            // Cargar m√©tricas
            try {
                const metrics = await fetchCampaignMetrics(campaignId);
                updateGlobalMetrics(metrics);
            } catch (error) {
                console.warn("[Campaign Detail] No metrics available yet");
            }

            // Cargar posts
            posts = await fetchCampaignPosts(campaignId);
            console.log("[Campaign Detail] Posts loaded:", posts.length);

            updateStats();
            renderPosts();
        } catch (error) {
            console.error("[Campaign Detail] Error loading data:", error);
            alert("Error al cargar la campa√±a");
            window.location.href = "/marketing/campa√±as";
        }
    }

    // ============================================
    // RENDERIZAR INFO DE CAMPA√ëA
    // ============================================
    function renderCampaignInfo() {
        if (!campaignData) return;

        const container = document.getElementById("campaignInfoCard");
        if (!container) return;

        const estadoLabel =
            campaignData.estado === "proxima"
                ? "üîµ Pr√≥xima"
                : campaignData.estado === "activa"
                  ? "üü¢ Activa"
                  : "‚ö™ Finalizada";

        const fechaInicio = new Date(campaignData.inicio).toLocaleDateString(
            "es-ES",
            { day: "numeric", month: "short", year: "numeric" },
        );
        const fechaFin = new Date(campaignData.fin).toLocaleDateString(
            "es-ES",
            {
                day: "numeric",
                month: "short",
                year: "numeric",
            },
        );

        container.innerHTML = `
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-3">
              <span class="px-3 py-1.5 bg-blue-50 dark:bg-blue-950/30 text-blue-700 dark:text-blue-400 rounded-full text-sm font-medium">
                ${estadoLabel}
              </span>
              <span class="text-gray-600 dark:text-gray-400 text-sm">
                ${fechaInicio} - ${fechaFin}
              </span>
            </div>
            <p class="text-gray-600 dark:text-gray-400">
              ${campaignData.objetivo}
            </p>
          </div>
        </div>
      `;
    }

    // ============================================
    // ACTUALIZAR M√âTRICAS GLOBALES
    // ============================================
    function updateGlobalMetrics(metrics: any) {
        document.getElementById("metric-reach")!.textContent =
            metrics.totalReach.toLocaleString();
        document.getElementById("metric-interactions")!.textContent =
            metrics.totalInteractions.toLocaleString();
        document.getElementById("metric-prereg")!.textContent =
            metrics.totalPreRegistrations.toLocaleString();
        document.getElementById("metric-enrollments")!.textContent =
            metrics.expectedEnrollments.toLocaleString();
    }

    // ============================================
    // ACTUALIZAR ESTAD√çSTICAS
    // ============================================
    function updateStats() {
        const total = posts.length;
        const byStatus = posts.reduce((acc: Record<string, number>, p) => {
            acc[p.estado] = (acc[p.estado] || 0) + 1;
            return acc;
        }, {});

        document.getElementById("stat-todos")!.textContent = String(total);
        document.getElementById("stat-draft")!.textContent = String(
            byStatus.draft || 0,
        );
        document.getElementById("stat-scheduled")!.textContent = String(
            byStatus.scheduled || 0,
        );
        document.getElementById("stat-published")!.textContent = String(
            byStatus.published || 0,
        );
    }

    // ============================================
    // RENDERIZAR POSTS
    // ============================================
    interface Filtros {
        estado?: string;
        busqueda?: string;
    }

    function renderPosts(filtros: Filtros = {}) {
        const container = document.getElementById("postsList");
        const emptyState = document.getElementById("emptyState");
        if (!container) return;

        let filtered = posts;

        // Filtro por estado
        if (filtros.estado && filtros.estado !== "todos") {
            filtered = filtered.filter((p) => p.estado === filtros.estado);
        }

        // Filtro por b√∫squeda
        if (filtros.busqueda) {
            filtered = filtered.filter((p) =>
                p.titulo
                    .toLowerCase()
                    .includes(filtros.busqueda!.toLowerCase()),
            );
        }

        if (filtered.length === 0) {
            container.classList.add("hidden");
            emptyState?.classList.remove("hidden");
            return;
        }

        container.classList.remove("hidden");
        emptyState?.classList.add("hidden");

        container.innerHTML = filtered
            .map((p) => {
                const estado = estadoConfig[p.estado];
                const plataforma =
                    plataformaConfig[
                        p.plataforma as keyof typeof plataformaConfig
                    ] || plataformaConfig.facebook;

                const fechaProgramada = p.programadoPara
                    ? new Date(p.programadoPara).toLocaleDateString("es-ES", {
                          day: "numeric",
                          month: "short",
                          hour: "2-digit",
                          minute: "2-digit",
                      })
                    : "No programado";

                return `
          <div class="p-6 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl hover:shadow-lg smooth-transition">
            <!-- Header -->
            <div class="flex items-start justify-between mb-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-2xl">${plataforma.icon}</span>
                  <span class="px-2 py-1 ${estado.bg} ${estado.text} rounded-full text-xs font-medium">
                    ${estado.icon} ${estado.label}
                  </span>
                </div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">
                  ${p.titulo}
                </h3>
              </div>
            </div>

            <!-- Contenido -->
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 line-clamp-3">
              ${p.contenido}
            </p>

            <!-- Info -->
            <div class="space-y-2 mb-4">
              <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
                <span class="truncate">${p.enlace}</span>
              </div>
              ${
                  p.estado === "scheduled"
                      ? `
                <div class="flex items-center gap-2 text-xs text-yellow-600 dark:text-yellow-400">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span>${fechaProgramada}</span>
                </div>
              `
                      : ""
              }
            </div>

            <!-- Acciones -->
            <div class="flex gap-2 pt-3 border-t border-gray-200 dark:border-gray-800">
              ${
                  p.estado === "published"
                      ? `
                <button
                  onclick="verMetricas(${p.id})"
                  class="flex-1 px-3 py-2 text-center text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-950/30 rounded-lg smooth-transition text-sm font-medium"
                >
                  üìä M√©tricas
                </button>
              `
                      : ""
              }
                            <button
                                onclick="editarPost(${p.id})"
                                class="flex-1 px-3 py-2 text-center text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-900 rounded-lg smooth-transition text-sm font-medium"
                            >
                                Editar
                            </button>
                            ${
                                    p.estado !== 'published'
                                            ? `
                            <button
                                onclick="publicarPost(${p.id})"
                                class="flex-1 px-3 py-2 text-center text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-950/30 rounded-lg smooth-transition text-sm font-medium"
                            >
                                üöÄ Publicar
                            </button>
                            `
                                            : ''
                            }
              <button
                onclick="eliminarPost(${p.id})"
                class="px-3 py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-950/30 rounded-lg smooth-transition text-sm font-medium"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>
        `;
            })
            .join("");
    }

    // ============================================
    // FUNCIONES GLOBALES
    // ============================================
    (window as any).verMetricas = async function (postId: number) {
        try {
            const metrics = await fetchPostMetrics(postId);

            const metricsContent = document.getElementById("metricsContent");
            if (metricsContent) {
                // Calcular tasa de engagement
                const engagementRate =
                    metrics.totales.alcance > 0
                        ? (
                              (metrics.totales.engagement /
                                  metrics.totales.alcance) *
                              100
                          ).toFixed(2)
                        : "0.00";

                // Calcular frecuencia (impressions/reach)
                const frecuencia =
                    metrics.totales.alcance > 0
                        ? (
                              metrics.totales.impresiones /
                              metrics.totales.alcance
                          ).toFixed(2)
                        : "0.00";

                metricsContent.innerHTML = `
        <div class="space-y-4">
          <!-- Header -->
          <div class="p-4 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-950/30 dark:to-purple-950/30 rounded-lg">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Publicaci√≥n</p>
            <p class="text-lg font-bold text-gray-900 dark:text-white">${metrics.postTitle}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Plataforma: ${metrics.platform}</p>
          </div>

          <!-- M√©tricas Principales -->
          <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <p class="text-sm text-gray-600 dark:text-gray-400">Alcance Total</p>
                <span class="text-2xl">üë•</span>
              </div>
              <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">${metrics.totales.alcance.toLocaleString()}</p>
            </div>

            <div class="p-4 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <p class="text-sm text-gray-600 dark:text-gray-400">Impresiones</p>
                <span class="text-2xl">üëÅÔ∏è</span>
              </div>
              <p class="text-3xl font-bold text-purple-600 dark:text-purple-400">${metrics.totales.impresiones.toLocaleString()}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Frecuencia: ${frecuencia}</p>
            </div>

            <div class="p-4 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <p class="text-sm text-gray-600 dark:text-gray-400">Vistas</p>
                <span class="text-2xl">‚ñ∂Ô∏è</span>
              </div>
              <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">${metrics.totales.vistas.toLocaleString()}</p>
            </div>

            <div class="p-4 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <p class="text-sm text-gray-600 dark:text-gray-400">Engagement</p>
                <span class="text-2xl">‚ö°</span>
              </div>
              <p class="text-3xl font-bold text-orange-600 dark:text-orange-400">${metrics.totales.engagement.toLocaleString()}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Tasa: ${engagementRate}%</p>
            </div>
          </div>

          <!-- Interacciones Detalladas -->
          <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
            <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Interacciones Detalladas</h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-950 rounded-lg">
                <div class="flex items-center gap-2">
                  <span class="text-xl">‚ù§Ô∏è</span>
                  <span class="text-sm text-gray-600 dark:text-gray-400">Likes</span>
                </div>
                <span class="text-lg font-bold text-pink-600 dark:text-pink-400">${metrics.totales.likes.toLocaleString()}</span>
              </div>

              <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-950 rounded-lg">
                <div class="flex items-center gap-2">
                  <span class="text-xl">üí¨</span>
                  <span class="text-sm text-gray-600 dark:text-gray-400">Comentarios</span>
                </div>
                <span class="text-lg font-bold text-blue-600 dark:text-blue-400">${metrics.totales.comentarios.toLocaleString()}</span>
              </div>

              <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-950 rounded-lg">
                <div class="flex items-center gap-2">
                  <span class="text-xl">üîÑ</span>
                  <span class="text-sm text-gray-600 dark:text-gray-400">Compartidos</span>
                </div>
                <span class="text-lg font-bold text-green-600 dark:text-green-400">${metrics.totales.compartidos.toLocaleString()}</span>
              </div>

              <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-950 rounded-lg">
                <div class="flex items-center gap-2">
                  <span class="text-xl">üîñ</span>
                  <span class="text-sm text-gray-600 dark:text-gray-400">Guardados</span>
                </div>
                <span class="text-lg font-bold text-yellow-600 dark:text-yellow-400">${metrics.totales.guardados.toLocaleString()}</span>
              </div>
            </div>
          </div>

          <!-- Desglose por Plataforma -->
          ${
              metrics.metricas.length > 1
                  ? `
          <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
            <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Desglose por Plataforma</h3>
            <div class="space-y-2">
              ${metrics.metricas
                  .map(
                      (m) => `
                <div class="p-3 bg-white dark:bg-gray-950 rounded-lg">
                  <div class="flex items-center justify-between mb-2">
                    <span class="font-medium text-gray-900 dark:text-white">${m.plataforma === "facebook" ? "üìò Facebook" : "üì∑ Instagram"}</span>
                    <span class="text-sm text-gray-500 dark:text-gray-400">${new Date(m.fecha).toLocaleDateString("es-ES")}</span>
                  </div>
                  <div class="grid grid-cols-4 gap-2 text-xs">
                    <div>
                      <p class="text-gray-600 dark:text-gray-400">Alcance</p>
                      <p class="font-bold text-gray-900 dark:text-white">${m.alcance.toLocaleString()}</p>
                    </div>
                    <div>
                      <p class="text-gray-600 dark:text-gray-400">Likes</p>
                      <p class="font-bold text-gray-900 dark:text-white">${m.likes.toLocaleString()}</p>
                    </div>
                    <div>
                      <p class="text-gray-600 dark:text-gray-400">Comentarios</p>
                      <p class="font-bold text-gray-900 dark:text-white">${m.comentarios.toLocaleString()}</p>
                    </div>
                    <div>
                      <p class="text-gray-600 dark:text-gray-400">Engagement</p>
                      <p class="font-bold text-gray-900 dark:text-white">${m.engagement.toLocaleString()}</p>
                    </div>
                  </div>
                </div>
              `,
                  )
                  .join("")}
            </div>
          </div>
          `
                  : ""
          }
        </div>
      `;
            }

            document.getElementById("modalMetrics")?.classList.remove("hidden");
            document.getElementById("modalMetrics")?.classList.add("flex");
        } catch (error) {
            console.error("Error loading metrics:", error);
            alert("No se pudieron cargar las m√©tricas de esta publicaci√≥n");
        }
    };

    (window as any).editarPost = function (postId: number) {
        const post = posts.find((p) => p.id === postId);
        if (!post) return;

        editingPostId = postId;

        // Llenar formulario
        (document.getElementById("postId") as HTMLInputElement).value =
            String(postId);
        (document.getElementById("postTitle") as HTMLInputElement).value =
            post.titulo;
        (document.getElementById("postPlatform") as HTMLSelectElement).value =
            post.plataforma;
        (
            document.getElementById("postContentType") as HTMLSelectElement
        ).value = post.tipo;
        (document.getElementById("postContent") as HTMLTextAreaElement).value =
            post.contenido;
        (document.getElementById("postImagePath") as HTMLInputElement).value =
            post.imagen || "";
        (document.getElementById("postLinkUrl") as HTMLInputElement).value =
            post.enlace;
        (document.getElementById("postStatus") as HTMLSelectElement).value =
            post.estado;

        if (post.programadoPara) {
            const fecha = new Date(post.programadoPara);
            const fechaLocal = new Date(
                fecha.getTime() - fecha.getTimezoneOffset() * 60000,
            )
                .toISOString()
                .slice(0, 16);
            (
                document.getElementById("postScheduledAt") as HTMLInputElement
            ).value = fechaLocal;
        }

        document.getElementById("modalTitle")!.textContent =
            "Editar Publicaci√≥n";
        document.getElementById("btnSubmitForm")!.textContent = "Actualizar";

        document.getElementById("modalPost")?.classList.remove("hidden");
        document.getElementById("modalPost")?.classList.add("flex");

        // Enable the header-level publish button when a post is selected for editing
        const publishBtn = document.getElementById('btnPublishSelected') as HTMLButtonElement | null;
        if (publishBtn) publishBtn.disabled = false;
    };

    (window as any).eliminarPost = async function (postId: number) {
        if (!confirm("¬øEst√°s seguro de eliminar esta publicaci√≥n?")) return;

        try {
            await deletePost(postId);
            posts = posts.filter((p) => p.id !== postId);
            updateStats();
            renderPosts();
            alert("‚úÖ Publicaci√≥n eliminada correctamente");
        } catch (error) {
            console.error("Error deleting post:", error);
            alert("‚ùå Error al eliminar la publicaci√≥n");
        }
    };

    (window as any).publicarPost = async function (postId: number) {
        if (!confirm('¬øDeseas publicar esta publicaci√≥n ahora?')) return;

        try {
            const updated = await publishPost(postId);
            const idx = posts.findIndex((p) => p.id === postId);
            if (idx !== -1) posts[idx] = updated;
            // If the published post is the one currently selected for editing, disable the header publish button
            if (editingPostId === postId) {
                const publishBtn = document.getElementById('btnPublishSelected') as HTMLButtonElement | null;
                if (publishBtn) publishBtn.disabled = true;
            }
            updateStats();
            renderPosts();
            alert('‚úÖ Publicaci√≥n publicada correctamente');
        } catch (error) {
            console.error('Error publishing post:', error);
            alert('‚ùå Error al publicar la publicaci√≥n');
        }
    };

    // ============================================
    // EVENT LISTENERS
    // ============================================
    document.addEventListener("DOMContentLoaded", async () => {
        await loadCampaignData();

        let filtrosActuales: Filtros = { estado: "todos" };

        // Filtros de estado
        document.querySelectorAll(".filter-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".filter-btn").forEach((b) => {
                    b.classList.remove(
                        "border-blue-500",
                        "dark:border-blue-500",
                    );
                    b.classList.add("border-gray-200", "dark:border-gray-800");
                });
                btn.classList.remove("border-gray-200", "dark:border-gray-800");
                btn.classList.add("border-blue-500", "dark:border-blue-500");

                filtrosActuales.estado =
                    btn.getAttribute("data-filter") || "todos";
                renderPosts(filtrosActuales);
            });
        });

        // B√∫squeda
        const searchInput = document.getElementById("searchInput");
        searchInput?.addEventListener("input", (e) => {
            filtrosActuales.busqueda = (e.target as HTMLInputElement).value;
            renderPosts(filtrosActuales);
        });

        // Limpiar filtros
        document
            .getElementById("btnLimpiarFiltros")
            ?.addEventListener("click", () => {
                filtrosActuales = { estado: "todos" };
                if (searchInput) (searchInput as HTMLInputElement).value = "";

                document.querySelectorAll(".filter-btn").forEach((b) => {
                    b.classList.remove(
                        "border-blue-500",
                        "dark:border-blue-500",
                    );
                    b.classList.add("border-gray-200", "dark:border-gray-800");
                });
                document
                    .querySelector('[data-filter="todos"]')
                    ?.classList.add("border-blue-500", "dark:border-blue-500");

                renderPosts(filtrosActuales);
            });

        // Modal Nuevo Post
        document
            .getElementById("btnNuevoPost")
            ?.addEventListener("click", () => {
                editingPostId = null;
                (
                    document.getElementById("formPost") as HTMLFormElement
                ).reset();
                (
                    document.getElementById("campaignId") as HTMLInputElement
                ).value = String(campaignId);
                document.getElementById("modalTitle")!.textContent =
                    "Nueva Publicaci√≥n";
                document.getElementById("btnSubmitForm")!.textContent = "Crear";

                document
                    .getElementById("modalPost")
                    ?.classList.remove("hidden");
                document.getElementById("modalPost")?.classList.add("flex");

                // When creating a new post, no selection is active
                const publishBtn = document.getElementById('btnPublishSelected') as HTMLButtonElement | null;
                if (publishBtn) publishBtn.disabled = true;
            });

        // Header-level publish button triggers publicarPost on the currently-selected editingPostId
        const headerPublish = document.getElementById('btnPublishSelected');
        headerPublish?.addEventListener('click', async () => {
            if (!editingPostId) return alert('Selecciona una publicaci√≥n para publicar (haz clic en Editar)');

            // Confirm and call existing publicarPost handler
            if (!confirm('¬øDeseas publicar la publicaci√≥n seleccionada ahora?')) return;

            try {
                const updated = await (window as any).publicarPost(editingPostId);
                // publicarPost already updates posts/ui inside the function; ensure header button disabled afterwards
                const btn = document.getElementById('btnPublishSelected') as HTMLButtonElement | null;
                if (btn) btn.disabled = true;
            } catch (err) {
                // publicarPost shows alerts on error; no-op here
            }
        });

        // Generar con IA (bot√≥n dentro del modal)
        document.getElementById('btnGenerateAI')?.addEventListener('click', async () => {
            const promptInput = document.getElementById('postPrompt') as HTMLInputElement;
            const platformSelect = document.getElementById('postPlatform') as HTMLSelectElement;
            const contentTypeSelect = document.getElementById('postContentType') as HTMLSelectElement;
            if (!promptInput || !platformSelect) return;

            const prompt = promptInput.value.trim();
            const platform = platformSelect.value as 'facebook' | 'instagram';
            const contentType = contentTypeSelect?.value as 'image' | 'video' | 'text' | undefined;
            if (!contentType) return alert('Selecciona tipo de contenido antes de generar con IA');

            // Instagram does not accept text-only posts
            if (platform === 'instagram' && contentType === 'text') {
                return alert('Instagram requiere una imagen o video; no es posible generar solo texto para Instagram');
            }
            if (!prompt) return alert('Escribe un prompt para generar');

            const btn = document.getElementById('btnGenerateAI') as HTMLButtonElement;
            btn.disabled = true;
            const original = btn.textContent;
            btn.textContent = 'Generando...';

            try {
                const linkInput = document.getElementById('postLinkUrl') as HTMLInputElement;
                const linkUrl = linkInput?.value || undefined;
                const resp = await generateDraft(prompt, platform, contentType, linkUrl);
                if (resp?.success) {
                    const data = resp.data ?? {}; 
                    // Fill title/content/image fields
                    if (data.suggested_content) {
                        (document.getElementById('postContent') as HTMLTextAreaElement).value = data.suggested_content;
                        // optional: fill title as first 80 chars
                        (document.getElementById('postTitle') as HTMLInputElement).value = data.suggested_content.split('\n')[0].slice(0, 80);
                    }

                    if (data.temp_image_url) {
                        (document.getElementById('postImageUrl') as HTMLInputElement).value = data.temp_image_url;
                        (document.getElementById('postImagePath') as HTMLInputElement).value = data.temp_image_url;
                    }

                } else {
                    alert('No se pudo generar el borrador: ' + (resp?.message || 'error'));
                }
            } catch (error) {
                console.error('Error generating draft:', error);
                alert('Error al generar borrador');
            } finally {
                btn.disabled = false;
                btn.textContent = original;
            }
        });

        // Cerrar modales
        [
            document.getElementById("btnCerrarModal"),
            document.getElementById("btnCancelarModal"),
        ].forEach((btn) => {
            btn?.addEventListener("click", () => {
                document.getElementById("modalPost")?.classList.add("hidden");
                document.getElementById("modalPost")?.classList.remove("flex");
            });
        });

        document
            .getElementById("btnCerrarMetrics")
            ?.addEventListener("click", () => {
                document
                    .getElementById("modalMetrics")
                    ?.classList.add("hidden");
                document
                    .getElementById("modalMetrics")
                    ?.classList.remove("flex");
            });

        // Submit form
        // Submit form
        document
            .getElementById("formPost")
            ?.addEventListener("submit", async (e) => {
                e.preventDefault();

                const userStr = localStorage.getItem("user");
                if (!userStr) {
                    alert("Error: No se pudo obtener el usuario");
                    return;
                }
                const user = JSON.parse(userStr);

                const scheduledAtValue = (
                    document.getElementById(
                        "postScheduledAt",
                    ) as HTMLInputElement
                ).value;

                const statusValue = (
                    document.getElementById("postStatus") as HTMLSelectElement
                ).value as "draft" | "scheduled" | "published";

                const btnSubmit = document.getElementById(
                    "btnSubmitForm",
                ) as HTMLButtonElement;
                const originalText = btnSubmit.textContent;
                btnSubmit.disabled = true;
                btnSubmit.textContent = editingPostId
                    ? "Actualizando..."
                    : "Creando...";

                try {
                    if (editingPostId) {
                        // ============================================
                        // ACTUALIZAR POST
                        // ============================================
                        const updateData: UpdatePostDTO = {
                            title: (
                                document.getElementById(
                                    "postTitle",
                                ) as HTMLInputElement
                            ).value,
                            platform: (
                                document.getElementById(
                                    "postPlatform",
                                ) as HTMLSelectElement
                            ).value as "facebook" | "instagram",
                            content: (
                                document.getElementById(
                                    "postContent",
                                ) as HTMLTextAreaElement
                            ).value,
                            content_type: (
                                document.getElementById(
                                    "postContentType",
                                ) as HTMLSelectElement
                            ).value as "image" | "video" | "text",
                            image_path: (
                                document.getElementById(
                                    "postImagePath",
                                ) as HTMLInputElement
                            ).value,
                            link_url: (
                                document.getElementById(
                                    "postLinkUrl",
                                ) as HTMLInputElement
                            ).value,
                            status: statusValue,
                            scheduled_at: scheduledAtValue || null,
                            published_at:
                                statusValue === "published"
                                    ? new Date()
                                          .toISOString()
                                          .slice(0, 19)
                                          .replace("T", " ")
                                    : null,
                        };

                        const updated = await updatePost(
                            editingPostId,
                            updateData,
                        );
                        const index = posts.findIndex(
                            (p) => p.id === editingPostId,
                        );
                        if (index !== -1) posts[index] = updated;
                    } else {
                        // ============================================
                        // CREAR POST
                        // ============================================
                        const createData: CreatePostDTO = {
                            campaign_id: campaignId,
                            title: (
                                document.getElementById(
                                    "postTitle",
                                ) as HTMLInputElement
                            ).value,
                            platform: (
                                document.getElementById(
                                    "postPlatform",
                                ) as HTMLSelectElement
                            ).value as "facebook" | "instagram",
                            content: (
                                document.getElementById(
                                    "postContent",
                                ) as HTMLTextAreaElement
                            ).value,
                            content_type: (
                                document.getElementById(
                                    "postContentType",
                                ) as HTMLSelectElement
                            ).value as "image" | "video" | "text",
                            image_path: (
                                document.getElementById(
                                    "postImagePath",
                                ) as HTMLInputElement
                            ).value,
                            image_url: (
                                document.getElementById(
                                    'postImageUrl',
                                ) as HTMLInputElement
                            ).value || null,
                            link_url: (
                                document.getElementById(
                                    "postLinkUrl",
                                ) as HTMLInputElement
                            ).value,
                            status: statusValue,
                            scheduled_at: scheduledAtValue || null,
                            published_at:
                                statusValue === "published"
                                    ? new Date()
                                          .toISOString()
                                          .slice(0, 19)
                                          .replace("T", " ")
                                    : null,
                            created_by: user.id,
                        };

                        const created = await createPost(createData);
                        posts.push(created);
                    }

                    updateStats();
                    renderPosts(filtrosActuales);

                    document
                        .getElementById("modalPost")
                        ?.classList.add("hidden");
                    document
                        .getElementById("modalPost")
                        ?.classList.remove("flex");

                    alert(
                        editingPostId
                            ? "‚úÖ Publicaci√≥n actualizada"
                            : "‚úÖ Publicaci√≥n creada",
                    );
                } catch (error) {
                    console.error("Error saving post:", error);
                    alert("‚ùå Error al guardar la publicaci√≥n");
                } finally {
                    btnSubmit.disabled = false;
                    btnSubmit.textContent = originalText;
                }
            });
    });
</script>
