---
import Layout from "../../../layouts/MarketingLayout.astro";
import { config } from "../../../config/marketing-config";

export async function getStaticPaths() {
    try {
        const url = `${config.apiUrl}${config.endpoints.campaigns.list}`;
        const response = await fetch(url);
        if (!response.ok)
            throw new Error(
                `Failed to fetch campaigns: ${response.statusText}`,
            );
        const campaigns = await response.json();
        return campaigns.map((campaign: any) => ({
            params: { id: campaign.id.toString() },
            props: { campaignId: campaign.id, campaignName: campaign.name },
        }));
    } catch (error) {
        console.error("[Build] Error in getStaticPaths:", error);
        return [];
    }
}

const { campaignId, campaignName } = Astro.props;
---

<Layout title={`${campaignName} - INCADEV UI`}>
    <div class="space-y-6" data-campaign-id={campaignId}>
        <!-- Header -->
        <div class="flex items-center justify-between gap-4 mb-6">
            <div class="flex items-center gap-4">
                <a
                    href="/marketing/campaigns"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-gray-900 rounded-lg transition-all"
                    >‚Üê Volver</a
                >
                <div>
                    <h1
                        id="campaignTitle"
                        class="text-3xl font-bold text-gray-900 dark:text-white"
                    >
                        Cargando...
                    </h1>
                    <p
                        id="campaignSubtitle"
                        class="text-gray-600 dark:text-gray-400"
                    >
                        Gestiona las publicaciones
                    </p>
                </div>
            </div>
            <button
                id="btnNuevoPost"
                class="px-6 py-3 bg-gradient-to-r from-violet-600 via-purple-600 to-fuchsia-600 hover:from-violet-700 hover:via-purple-700 hover:to-fuchsia-700 text-white rounded-xl font-medium transition-all flex items-center gap-2 shadow-lg shadow-violet-500/25"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"></path></svg
                >
                Nueva Publicaci√≥n
            </button>
        </div>

        <!-- Campaign Info -->
        <div
            id="campaignInfoCard"
            class="p-6 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl"
        >
        </div>

        <!-- M√©tricas -->
        <div
            class="p-6 bg-gradient-to-br from-violet-50 to-fuchsia-50 dark:from-violet-950/30 dark:to-fuchsia-950/30 border border-violet-200 dark:border-violet-900/50 rounded-xl"
        >
            <h2
                class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2"
            >
                üìä M√©tricas Globales
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <p
                        id="metric-reach"
                        class="text-3xl font-bold text-violet-600"
                    >
                        0
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Alcance
                    </p>
                </div>
                <div class="text-center">
                    <p
                        id="metric-interactions"
                        class="text-3xl font-bold text-purple-600"
                    >
                        0
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Interacciones
                    </p>
                </div>
                <div class="text-center">
                    <p
                        id="metric-prereg"
                        class="text-3xl font-bold text-green-600"
                    >
                        0
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Pre-inscripciones
                    </p>
                </div>
                <div class="text-center">
                    <p
                        id="metric-enrollments"
                        class="text-3xl font-bold text-emerald-600"
                    >
                        0
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Inscripciones
                    </p>
                </div>
            </div>
        </div>

        <!-- Stats Filters -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button
                class="filter-btn p-4 bg-white dark:bg-gray-950 border-2 border-violet-500 rounded-lg"
                data-filter="todos"
            >
                <p
                    id="stat-todos"
                    class="text-2xl font-bold text-gray-900 dark:text-white"
                >
                    0
                </p>
                <p class="text-xs text-gray-600 dark:text-gray-400 font-medium">
                    Todas
                </p>
            </button>
            <button
                class="filter-btn p-4 bg-white dark:bg-gray-950 border-2 border-gray-200 dark:border-gray-800 hover:border-gray-500 rounded-lg"
                data-filter="draft"
            >
                <p id="stat-draft" class="text-2xl font-bold text-gray-600">
                    0
                </p>
                <p class="text-xs text-gray-600 dark:text-gray-400 font-medium">
                    Borradores
                </p>
            </button>
            <button
                class="filter-btn p-4 bg-white dark:bg-gray-950 border-2 border-gray-200 dark:border-gray-800 hover:border-yellow-500 rounded-lg"
                data-filter="scheduled"
            >
                <p
                    id="stat-scheduled"
                    class="text-2xl font-bold text-yellow-600"
                >
                    0
                </p>
                <p class="text-xs text-gray-600 dark:text-gray-400 font-medium">
                    Programadas
                </p>
            </button>
            <button
                class="filter-btn p-4 bg-white dark:bg-gray-950 border-2 border-gray-200 dark:border-gray-800 hover:border-green-500 rounded-lg"
                data-filter="published"
            >
                <p
                    id="stat-published"
                    class="text-2xl font-bold text-green-600"
                >
                    0
                </p>
                <p class="text-xs text-gray-600 dark:text-gray-400 font-medium">
                    Publicadas
                </p>
            </button>
        </div>

        <!-- Search -->
        <div class="flex gap-4">
            <div class="flex-1 relative">
                <svg
                    class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input
                    id="searchInput"
                    type="text"
                    placeholder="Buscar publicaciones..."
                    class="w-full pl-12 pr-4 py-3 bg-white dark:bg-gray-950 border border-gray-300 dark:border-gray-800 rounded-lg focus:ring-2 focus:ring-violet-500 text-gray-900 dark:text-white"
                />
            </div>
            <button
                id="btnLimpiarFiltros"
                class="px-6 py-3 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-900"
                >Limpiar</button
            >
        </div>

        <!-- Posts Grid -->
        <div
            id="postsList"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <div
                class="w-20 h-20 bg-gray-100 dark:bg-gray-900 rounded-full flex items-center justify-center mx-auto mb-4"
            >
                <span class="text-4xl">üìù</span>
            </div>
            <h3
                class="text-lg font-semibold text-gray-900 dark:text-white mb-2"
            >
                No hay publicaciones
            </h3>
            <p class="text-gray-600 dark:text-gray-400">
                Crea tu primera publicaci√≥n para esta campa√±a
            </p>
        </div>
    </div>
    <!-- ========================================== -->
    <!-- MODAL NUEVA/EDITAR PUBLICACI√ìN -->
    <!-- ========================================== -->
    <div
        id="modalPost"
        class="fixed inset-0 bg-black/60 backdrop-blur-md hidden items-center justify-center z-50 p-4"
    >
        <div
            class="bg-white dark:bg-gray-950 rounded-2xl shadow-2xl max-w-5xl w-full max-h-[95vh] overflow-hidden border border-gray-200 dark:border-gray-800 flex flex-col"
        >
            <!-- Header -->
            <div
                class="px-6 py-4 bg-gradient-to-r from-violet-600 via-purple-600 to-fuchsia-600 flex items-center justify-between"
            >
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center"
                    >
                        <span class="text-xl">‚ú®</span>
                    </div>
                    <div>
                        <h2
                            id="modalTitle"
                            class="text-xl font-bold text-white"
                        >
                            Crear Publicaci√≥n
                        </h2>
                        <p class="text-white/70 text-sm">
                            Genera contenido con IA
                        </p>
                    </div>
                </div>
                <button
                    id="btnCerrarModal"
                    class="p-2 hover:bg-white/20 rounded-lg transition-all"
                >
                    <svg
                        class="w-6 h-6 text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Progress Steps -->
            <div
                class="px-6 py-4 border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900/50"
            >
                <div class="flex items-center justify-center gap-4">
                    <div
                        id="step1Indicator"
                        class="flex items-center gap-2 px-4 py-2 rounded-full bg-violet-100 dark:bg-violet-900/30 text-violet-700 dark:text-violet-300 font-medium text-sm"
                    >
                        <span
                            class="w-6 h-6 rounded-full bg-violet-600 text-white flex items-center justify-center text-xs font-bold"
                            >1</span
                        >
                        Configurar
                    </div>
                    <div class="w-12 h-0.5 bg-gray-300 dark:bg-gray-700"></div>
                    <div
                        id="step2Indicator"
                        class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 font-medium text-sm"
                    >
                        <span
                            class="w-6 h-6 rounded-full bg-gray-300 dark:bg-gray-700 text-gray-600 dark:text-gray-400 flex items-center justify-center text-xs font-bold"
                            >2</span
                        >
                        Preview
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto">
                <form id="formPost" class="h-full">
                    <input type="hidden" id="postId" />
                    <input type="hidden" id="postCampaignId" />
                    <input type="hidden" id="postImageUrl" />

                    <!-- STEP 1: Configuraci√≥n -->
                    <div id="step1Content" class="p-6 space-y-6">
                        <!-- Plataforma -->
                        <div>
                            <label
                                class="block text-sm font-semibold text-gray-900 dark:text-white mb-3"
                                >Selecciona la plataforma</label
                            >
                            <div class="grid grid-cols-2 gap-4">
                                <label class="cursor-pointer">
                                    <input
                                        type="radio"
                                        name="platform"
                                        value="facebook"
                                        class="sr-only peer"
                                    />
                                    <div
                                        class="p-5 rounded-xl border-2 border-gray-200 dark:border-gray-700 peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-950/30 hover:border-blue-300 transition-all"
                                    >
                                        <div class="flex items-center gap-4">
                                            <span class="text-4xl">üìò</span>
                                            <div>
                                                <p
                                                    class="font-bold text-gray-900 dark:text-white text-lg"
                                                >
                                                    Facebook
                                                </p>
                                                <p
                                                    class="text-sm text-gray-500"
                                                >
                                                    Posts largos, links
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input
                                        type="radio"
                                        name="platform"
                                        value="instagram"
                                        class="sr-only peer"
                                    />
                                    <div
                                        class="p-5 rounded-xl border-2 border-gray-200 dark:border-gray-700 peer-checked:border-pink-500 peer-checked:bg-pink-50 dark:peer-checked:bg-pink-950/30 hover:border-pink-300 transition-all"
                                    >
                                        <div class="flex items-center gap-4">
                                            <span class="text-4xl">üì∑</span>
                                            <div>
                                                <p
                                                    class="font-bold text-gray-900 dark:text-white text-lg"
                                                >
                                                    Instagram
                                                </p>
                                                <p
                                                    class="text-sm text-gray-500"
                                                >
                                                    Visual, hashtags
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Tipo de Contenido -->
                        <div>
                            <label
                                class="block text-sm font-semibold text-gray-900 dark:text-white mb-3"
                                >Tipo de contenido</label
                            >
                            <div class="grid grid-cols-3 gap-3">
                                <label class="cursor-pointer">
                                    <input
                                        type="radio"
                                        name="contentType"
                                        value="image"
                                        class="sr-only peer"
                                    />
                                    <div
                                        class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 peer-checked:border-violet-500 peer-checked:bg-violet-50 dark:peer-checked:bg-violet-950/30 text-center transition-all"
                                    >
                                        <span class="text-2xl block mb-2"
                                            >üñºÔ∏è</span
                                        >
                                        <p class="font-medium text-sm">
                                            Imagen
                                        </p>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input
                                        type="radio"
                                        name="contentType"
                                        value="video"
                                        class="sr-only peer"
                                    />
                                    <div
                                        class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 peer-checked:border-violet-500 peer-checked:bg-violet-50 dark:peer-checked:bg-violet-950/30 text-center transition-all"
                                    >
                                        <span class="text-2xl block mb-2"
                                            >üé¨</span
                                        >
                                        <p class="font-medium text-sm">Video</p>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input
                                        type="radio"
                                        name="contentType"
                                        value="text"
                                        class="sr-only peer"
                                    />
                                    <div
                                        class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 peer-checked:border-violet-500 peer-checked:bg-violet-50 dark:peer-checked:bg-violet-950/30 text-center transition-all"
                                    >
                                        <span class="text-2xl block mb-2"
                                            >üìù</span
                                        >
                                        <p class="font-medium text-sm">
                                            Solo Texto
                                        </p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Prompt IA -->
                        <div
                            class="p-5 rounded-xl bg-gradient-to-br from-violet-50 to-fuchsia-50 dark:from-violet-950/20 dark:to-fuchsia-950/20 border border-violet-200 dark:border-violet-800/50"
                        >
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-xl">‚ú®</span>
                                <label
                                    class="text-sm font-semibold text-gray-900 dark:text-white"
                                    >Describe tu publicaci√≥n</label
                                >
                            </div>
                            <textarea
                                id="postPrompt"
                                rows="3"
                                placeholder="Ej: Promoci√≥n del curso de Excel con 20% de descuento, mencionar certificaci√≥n incluida..."
                                class="w-full px-4 py-3 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-violet-500 text-gray-900 dark:text-white resize-none"
                            ></textarea>
                            <div class="flex items-center justify-between mt-3">
                                <p class="text-xs text-gray-500">
                                    S√© espec√≠fico para mejores resultados
                                </p>
                                <select
                                    id="promptTone"
                                    class="text-xs px-3 py-1.5 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg"
                                >
                                    <option value="professional"
                                        >üéØ Profesional</option
                                    >
                                    <option value="casual">üòä Casual</option>
                                    <option value="formal">üëî Formal</option>
                                    <option value="friendly">ü§ù Amigable</option
                                    >
                                    <option value="urgent">‚ö° Urgente</option>
                                </select>
                            </div>
                        </div>

                        <!-- URL -->
                        <div>
                            <label
                                class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >URL de destino (opcional)</label
                            >
                            <div class="relative">
                                <span
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"
                                    >üîó</span
                                >
                                <input
                                    type="url"
                                    id="postLinkUrl"
                                    placeholder="https://..."
                                    class="w-full pl-12 pr-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-violet-500 text-gray-900 dark:text-white"
                                />
                            </div>
                        </div>

                        <!-- Bot√≥n Generar -->
                        <button
                            type="button"
                            id="btnGenerateAI"
                            class="w-full py-4 bg-gradient-to-r from-violet-600 via-purple-600 to-fuchsia-600 hover:from-violet-700 hover:via-purple-700 hover:to-fuchsia-700 text-white rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-3 shadow-lg shadow-violet-500/25 hover:shadow-violet-500/40 hover:scale-[1.02] active:scale-[0.98]"
                        >
                            <span class="text-2xl">‚ú®</span>
                            Generar con IA
                            <svg
                                class="w-5 h-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
                    </div>
                    <!-- STEP 2: Preview y Guardar -->
                    <div id="step2Content" class="hidden">
                        <div
                            class="grid grid-cols-1 lg:grid-cols-2 gap-0 h-full"
                        >
                            <!-- Editor -->
                            <div
                                class="p-6 space-y-5 border-r border-gray-200 dark:border-gray-800"
                            >
                                <div class="flex items-center justify-between">
                                    <button
                                        type="button"
                                        id="btnBackToStep1"
                                        class="flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-violet-600"
                                    >
                                        <svg
                                            class="w-5 h-5"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                            ><path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M15 19l-7-7 7-7"></path></svg
                                        >
                                        Volver
                                    </button>
                                    <button
                                        type="button"
                                        id="btnRegenerateAI"
                                        class="flex items-center gap-2 px-4 py-2 text-violet-600 hover:bg-violet-50 dark:hover:bg-violet-950/30 rounded-lg text-sm font-medium"
                                    >
                                        üîÑ Regenerar
                                    </button>
                                </div>

                                <div>
                                    <label
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                        >T√≠tulo</label
                                    >
                                    <input
                                        type="text"
                                        id="postTitle"
                                        required
                                        placeholder="T√≠tulo descriptivo"
                                        class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-violet-500 text-gray-900 dark:text-white"
                                    />
                                </div>

                                <div>
                                    <div
                                        class="flex items-center justify-between mb-2"
                                    >
                                        <label
                                            class="text-sm font-semibold text-gray-900 dark:text-white"
                                            >Contenido</label
                                        >
                                        <span
                                            id="charCount"
                                            class="text-xs text-gray-500"
                                            >0 caracteres</span
                                        >
                                    </div>
                                    <textarea
                                        id="postContent"
                                        required
                                        rows="6"
                                        placeholder="Contenido generado..."
                                        class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-violet-500 text-gray-900 dark:text-white resize-none"
                                    ></textarea>
                                </div>

                                <div>
                                    <label
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                        >Imagen</label
                                    >
                                    <div
                                        class="p-6 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-center"
                                    >
                                        <span class="text-3xl">üñºÔ∏è</span>
                                        <p
                                            class="text-sm text-gray-600 dark:text-gray-400 mt-2"
                                        >
                                            Generaci√≥n de im√°genes -
                                            Pr√≥ximamente
                                        </p>
                                    </div>
                                    <input
                                        type="text"
                                        id="postImagePath"
                                        placeholder="O ingresa URL de imagen..."
                                        class="mt-3 w-full px-4 py-2 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-sm"
                                    />
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label
                                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                            >Estado</label
                                        >
                                        <select
                                            id="postStatus"
                                            class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-xl"
                                        >
                                            <option value="draft"
                                                >üìù Borrador</option
                                            >
                                            <option value="scheduled"
                                                >üìÖ Programado</option
                                            >
                                        </select>
                                    </div>
                                    <div>
                                        <label
                                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                            >Fecha</label
                                        >
                                        <input
                                            type="datetime-local"
                                            id="postScheduledAt"
                                            class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-xl"
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- Preview -->
                            <div
                                class="p-6 bg-gray-100 dark:bg-gray-900 flex flex-col"
                            >
                                <div
                                    class="flex items-center justify-between mb-4"
                                >
                                    <h3
                                        class="font-semibold text-gray-900 dark:text-white"
                                    >
                                        üëÅÔ∏è Vista Previa
                                    </h3>
                                    <span
                                        id="previewPlatformBadge"
                                        class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-sm font-medium"
                                        >Facebook</span
                                    >
                                </div>

                                <!-- Facebook Preview -->
                                <div
                                    id="facebookPreview"
                                    class="flex-1 bg-white dark:bg-gray-950 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-800"
                                >
                                    <div
                                        class="p-4 flex items-center gap-3 border-b border-gray-100 dark:border-gray-800"
                                    >
                                        <div
                                            class="w-10 h-10 rounded-full bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center text-white font-bold"
                                        >
                                            I
                                        </div>
                                        <div>
                                            <p
                                                class="font-semibold text-gray-900 dark:text-white text-sm"
                                            >
                                                INCADEV
                                            </p>
                                            <p class="text-xs text-gray-500">
                                                Ahora ¬∑ üåê
                                            </p>
                                        </div>
                                    </div>
                                    <div class="p-4">
                                        <p
                                            id="previewContent"
                                            class="text-gray-900 dark:text-white text-sm whitespace-pre-wrap mb-3"
                                        >
                                            El contenido aparecer√° aqu√≠...
                                        </p>
                                    </div>
                                    <!-- ‚úÖ AGREGAR: Contenedor de imagen Facebook -->
                                    <div id="previewImageFB" class="hidden">
                                        <img
                                            id="previewImageFBImg"
                                            src=""
                                            alt="Preview"
                                            class="w-full h-auto"
                                        />
                                    </div>
                                    <div
                                        class="px-4 py-3 border-t border-gray-100 dark:border-gray-800 flex items-center justify-around text-gray-500 text-sm"
                                    >
                                        <span>üëç Me gusta</span>
                                        <span>üí¨ Comentar</span>
                                        <span>‚ÜóÔ∏è Compartir</span>
                                    </div>
                                </div>
                                <!-- Instagram Preview -->
                                <div
                                    id="instagramPreview"
                                    class="hidden flex-1 bg-white dark:bg-gray-950 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-800"
                                >
                                    <div
                                        class="p-3 flex items-center gap-3 border-b border-gray-100 dark:border-gray-800"
                                    >
                                        <div
                                            class="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-400 via-pink-500 to-purple-600 p-0.5"
                                        >
                                            <div
                                                class="w-full h-full rounded-full bg-white dark:bg-gray-950 flex items-center justify-center text-xs font-bold"
                                            >
                                                I
                                            </div>
                                        </div>
                                        <p
                                            class="font-semibold text-gray-900 dark:text-white text-sm"
                                        >
                                            incadev_oficial
                                        </p>
                                    </div>
                                    <!-- ‚úÖ MODIFICAR: Contenedor de imagen Instagram -->
                                    <div
                                        id="previewImageIG"
                                        class="aspect-square bg-gray-200 dark:bg-gray-800 flex items-center justify-center"
                                    >
                                        <img
                                            id="previewImageIGImg"
                                            src=""
                                            alt="Preview"
                                            class="hidden w-full h-full object-cover"
                                        />
                                        <span
                                            id="previewImageIGPlaceholder"
                                            class="text-4xl">üñºÔ∏è</span
                                        >
                                    </div>
                                    <div
                                        class="p-3 flex items-center justify-between"
                                    >
                                        <div class="flex gap-4 text-xl">
                                            ‚ù§Ô∏è üí¨ üì§
                                        </div>
                                        <span class="text-xl">üîñ</span>
                                    </div>
                                    <div class="px-3 pb-3">
                                        <p class="text-sm">
                                            <span class="font-semibold"
                                                >incadev_oficial</span
                                            >
                                            <span id="previewContentIG"
                                                >Caption aqu√≠...</span
                                            >
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div
                            class="p-4 border-t border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900/50 flex items-center justify-between"
                        >
                            <button
                                type="button"
                                id="btnCancelarModal"
                                class="px-6 py-3 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-100 dark:hover:bg-gray-800"
                            >
                                Cancelar
                            </button>
                            <button
                                type="submit"
                                id="btnSubmitForm"
                                class="px-8 py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-700 hover:to-purple-700 text-white rounded-xl font-bold shadow-lg flex items-center gap-2"
                            >
                                <svg
                                    class="w-5 h-5"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                    ><path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M5 13l4 4L19 7"></path></svg
                                >
                                Guardar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div
        id="aiLoadingOverlay"
        class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-[60]"
    >
        <div
            class="bg-white dark:bg-gray-900 rounded-2xl p-8 max-w-sm w-full mx-4 text-center shadow-2xl"
        >
            <div class="relative w-20 h-20 mx-auto mb-6">
                <div
                    class="absolute inset-0 rounded-full border-4 border-violet-200"
                >
                </div>
                <div
                    class="absolute inset-0 rounded-full border-4 border-violet-600 border-t-transparent animate-spin"
                >
                </div>
                <div
                    class="absolute inset-2 rounded-full bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center"
                >
                    <span class="text-2xl">‚ú®</span>
                </div>
            </div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">
                Generando contenido
            </h3>
            <p class="text-gray-500 text-sm">
                La IA est√° creando tu publicaci√≥n...
            </p>
        </div>
    </div>

    <!-- Modal M√©tricas -->
    <div
        id="modalMetrics"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4"
    >
        <div
            class="bg-white dark:bg-gray-950 rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-gray-800"
        >
            <div
                class="p-6 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between"
            >
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                    üìä M√©tricas
                </h2>
                <button
                    id="btnCerrarMetrics"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-gray-900 rounded-lg"
                >
                    <svg
                        class="w-6 h-6 text-gray-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="metricsContent" class="p-6"></div>
        </div>
    </div>
    <script>
        import {
            fetchCampaignById,
            fetchCampaignPosts,
            fetchCampaignMetrics,
            createPost,
            publishPost,
            updatePost,
            deletePost,
            fetchPostMetrics,
            type CampaignForUI,
            type PostForUI,
            type CreatePostDTO,
            type UpdatePostDTO,
        } from "../../../services/marketing/index";
        import {
            generateText,
            generateImage,
        } from "../../../services/marketing/generationService";
        import { config } from "../../../config/marketing-config";

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        const mainDiv = document.querySelector(
            "[data-campaign-id]",
        ) as HTMLElement;
        const campaignId = parseInt(mainDiv?.dataset.campaignId || "0", 10);

        let campaignData: CampaignForUI | null = null;
        let posts: PostForUI[] = [];
        let filtrosActuales: { estado?: string; busqueda?: string } = {
            estado: "todos",
        };

        // Modal State
        let currentStep: 1 | 2 = 1;
        let selectedPlatform: "facebook" | "instagram" | null = null;
        let selectedContentType: "image" | "video" | "text" | null = null;
        let isEditingPost = false;
        let editingPostId: number | null = null;

        const estadoConfig: Record<
            string,
            { label: string; bg: string; text: string; icon: string }
        > = {
            draft: {
                label: "Borrador",
                bg: "bg-gray-100 dark:bg-gray-800",
                text: "text-gray-700 dark:text-gray-400",
                icon: "üìù",
            },
            scheduled: {
                label: "Programado",
                bg: "bg-yellow-50 dark:bg-yellow-950/30",
                text: "text-yellow-700 dark:text-yellow-400",
                icon: "üìÖ",
            },
            published: {
                label: "Publicado",
                bg: "bg-green-50 dark:bg-green-950/30",
                text: "text-green-700 dark:text-green-400",
                icon: "‚úÖ",
            },
        };

        const plataformaConfig: Record<string, { icon: string }> = {
            facebook: { icon: "üìò" },
            instagram: { icon: "üì∑" },
        };

        // ============================================
        // AI GENERATION
        // ============================================
        interface GenerateTextResponse {
            success: boolean;
            status: number;
            payload?: {
                candidates?: Array<{
                    content?: { parts?: Array<{ text?: string }> };
                }>;
            };
            body?: string;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showToast(
            message: string,
            type: "success" | "error" | "warning" = "success",
        ) {
            const toast = document.createElement("div");
            const colors = {
                success: "bg-green-600 text-white",
                error: "bg-red-600 text-white",
                warning: "bg-yellow-500 text-gray-900",
            };
            const icons = { success: "‚úÖ", error: "‚ùå", warning: "‚ö†Ô∏è" };
            toast.className = `fixed bottom-4 right-4 z-[70] px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 transform translate-y-full opacity-0 transition-all duration-300 ${colors[type]}`;
            toast.innerHTML = `<span class="text-lg">${icons[type]}</span><span class="font-medium">${message}</span>`;
            document.body.appendChild(toast);
            requestAnimationFrame(() =>
                toast.classList.remove("translate-y-full", "opacity-0"),
            );
            setTimeout(() => {
                toast.classList.add("translate-y-full", "opacity-0");
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showLoading() {
            const overlay = document.getElementById("aiLoadingOverlay");
            overlay?.classList.remove("hidden");
            overlay?.classList.add("flex");
        }

        function hideLoading() {
            const overlay = document.getElementById("aiLoadingOverlay");
            overlay?.classList.add("hidden");
            overlay?.classList.remove("flex");
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function openModal(editPost?: PostForUI) {
            const modal = document.getElementById("modalPost");
            (
                document.getElementById("postCampaignId") as HTMLInputElement
            ).value = String(campaignId);

            if (editPost) {
                isEditingPost = true;
                editingPostId = editPost.id;
                populateFormForEdit(editPost);
                goToStep(2);
                document.getElementById("modalTitle")!.textContent =
                    "Editar Publicaci√≥n";
            } else {
                isEditingPost = false;
                editingPostId = null;
                resetForm();
                goToStep(1);
                document.getElementById("modalTitle")!.textContent =
                    "Crear Publicaci√≥n";
            }

            modal?.classList.remove("hidden");
            modal?.classList.add("flex");
            document.body.style.overflow = "hidden";
        }

        function closeModal() {
            const modal = document.getElementById("modalPost");
            modal?.classList.add("hidden");
            modal?.classList.remove("flex");
            document.body.style.overflow = "";
        }

        function goToStep(step: 1 | 2) {
            currentStep = step;
            const step1 = document.getElementById("step1Content");
            const step2 = document.getElementById("step2Content");
            const ind1 = document.getElementById("step1Indicator");
            const ind2 = document.getElementById("step2Indicator");

            if (step === 1) {
                step1?.classList.remove("hidden");
                step2?.classList.add("hidden");
                ind1?.classList.remove("bg-gray-100", "text-gray-500");
                ind1?.classList.add("bg-violet-100", "text-violet-700");
                ind2?.classList.remove("bg-violet-100", "text-violet-700");
                ind2?.classList.add("bg-gray-100", "text-gray-500");
            } else {
                step1?.classList.add("hidden");
                step2?.classList.remove("hidden");
                ind2?.classList.remove("bg-gray-100", "text-gray-500");
                ind2?.classList.add("bg-violet-100", "text-violet-700");
            }
        }

        function populateFormForEdit(post: PostForUI) {
            (document.getElementById("postId") as HTMLInputElement).value =
                String(post.id);

            const platformRadio = document.querySelector(
                `input[name="platform"][value="${post.plataforma}"]`,
            ) as HTMLInputElement;
            if (platformRadio) {
                platformRadio.checked = true;
                selectedPlatform = post.plataforma as any;
            }

            const typeRadio = document.querySelector(
                `input[name="contentType"][value="${post.tipo}"]`,
            ) as HTMLInputElement;
            if (typeRadio) {
                typeRadio.checked = true;
                selectedContentType = post.tipo as any;
            }

            (document.getElementById("postTitle") as HTMLInputElement).value =
                post.titulo || "";
            (
                document.getElementById("postContent") as HTMLTextAreaElement
            ).value = post.contenido || "";
            (
                document.getElementById("postImagePath") as HTMLInputElement
            ).value = post.imagen || "";
            (document.getElementById("postLinkUrl") as HTMLInputElement).value =
                post.enlace || "";
            (document.getElementById("postStatus") as HTMLSelectElement).value =
                post.estado || "draft";

            if (post.programadoPara) {
                const fecha = new Date(post.programadoPara);
                (
                    document.getElementById(
                        "postScheduledAt",
                    ) as HTMLInputElement
                ).value = new Date(
                    fecha.getTime() - fecha.getTimezoneOffset() * 60000,
                )
                    .toISOString()
                    .slice(0, 16);
            }

            updatePreview();
            updatePreviewPlatform();
        }

        function resetForm() {
            (document.getElementById("formPost") as HTMLFormElement).reset();
            selectedPlatform = null;
            selectedContentType = null;
            (document.getElementById("postId") as HTMLInputElement).value = "";
        }

        function updatePreview() {
            const content =
                (document.getElementById("postContent") as HTMLTextAreaElement)
                    .value || "El contenido aparecer√° aqu√≠...";

            // Actualizar texto en ambos previews
            document.getElementById("previewContent")!.textContent = content;
            document.getElementById("previewContentIG")!.textContent = content;
            document.getElementById("charCount")!.textContent =
                `${content.length} caracteres`;

            // ‚úÖ AGREGAR: Actualizar imagen en previews
            const imageUrl = (
                document.getElementById("postImageUrl") as HTMLInputElement
            ).value;

            if (imageUrl) {
                // Facebook preview
                const fbImageContainer =
                    document.getElementById("previewImageFB");
                const fbImage = document.getElementById(
                    "previewImageFBImg",
                ) as HTMLImageElement;
                if (fbImageContainer && fbImage) {
                    fbImage.src = imageUrl;
                    fbImageContainer.classList.remove("hidden");
                }

                // Instagram preview
                const igImage = document.getElementById(
                    "previewImageIGImg",
                ) as HTMLImageElement;
                const igPlaceholder = document.getElementById(
                    "previewImageIGPlaceholder",
                );
                if (igImage && igPlaceholder) {
                    igImage.src = imageUrl;
                    igImage.classList.remove("hidden");
                    igPlaceholder.classList.add("hidden");
                }
            } else {
                // Si no hay imagen, ocultar/mostrar placeholders
                const fbImageContainer =
                    document.getElementById("previewImageFB");
                if (fbImageContainer) {
                    fbImageContainer.classList.add("hidden");
                }

                const igImage = document.getElementById(
                    "previewImageIGImg",
                ) as HTMLImageElement;
                const igPlaceholder = document.getElementById(
                    "previewImageIGPlaceholder",
                );
                if (igImage && igPlaceholder) {
                    igImage.classList.add("hidden");
                    igPlaceholder.classList.remove("hidden");
                }
            }
        }

        function updatePreviewPlatform() {
            const fb = document.getElementById("facebookPreview");
            const ig = document.getElementById("instagramPreview");
            const badge = document.getElementById("previewPlatformBadge");

            if (selectedPlatform === "facebook") {
                fb?.classList.remove("hidden");
                fb?.classList.add("flex-1");
                ig?.classList.add("hidden");
                ig?.classList.remove("flex-1");
                if (badge) {
                    badge.textContent = "Facebook";
                    badge.className =
                        "px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-sm font-medium";
                }
            } else {
                fb?.classList.add("hidden");
                fb?.classList.remove("flex-1");
                ig?.classList.remove("hidden");
                ig?.classList.add("flex-1");
                if (badge) {
                    badge.textContent = "Instagram";
                    badge.className =
                        "px-3 py-1 rounded-full bg-pink-100 text-pink-700 text-sm font-medium";
                }
            }
        }
        // ============================================
        // DATA LOADING
        // ============================================
        async function loadCampaignData() {
            try {
                campaignData = await fetchCampaignById(campaignId);
                document.getElementById("campaignTitle")!.textContent =
                    campaignData.nombre;
                document.getElementById("campaignSubtitle")!.textContent =
                    campaignData.objetivo;
                renderCampaignInfo();

                try {
                    const metrics = await fetchCampaignMetrics(campaignId);
                    document.getElementById("metric-reach")!.textContent =
                        metrics.totalReach?.toLocaleString() || "0";
                    document.getElementById(
                        "metric-interactions",
                    )!.textContent =
                        metrics.totalInteractions?.toLocaleString() || "0";
                    document.getElementById("metric-prereg")!.textContent =
                        metrics.totalPreRegistrations?.toLocaleString() || "0";
                    document.getElementById("metric-enrollments")!.textContent =
                        metrics.expectedEnrollments?.toLocaleString() || "0";
                } catch (e) {
                    console.warn("No metrics");
                }

                posts = await fetchCampaignPosts(campaignId);
                updateStats();
                renderPosts();
            } catch (error) {
                console.error("Error loading:", error);
                alert("Error al cargar la campa√±a");
                window.location.href = "/marketing/campaigns";
            }
        }

        function renderCampaignInfo() {
            if (!campaignData) return;
            const container = document.getElementById("campaignInfoCard");
            if (!container) return;

            const estadoLabel =
                campaignData.estado === "proxima"
                    ? "üîµ Pr√≥xima"
                    : campaignData.estado === "activa"
                      ? "üü¢ Activa"
                      : "‚ö™ Finalizada";
            const fechaInicio = new Date(
                campaignData.inicio,
            ).toLocaleDateString("es-ES", {
                day: "numeric",
                month: "short",
                year: "numeric",
            });
            const fechaFin = new Date(campaignData.fin).toLocaleDateString(
                "es-ES",
                { day: "numeric", month: "short", year: "numeric" },
            );

            container.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="px-3 py-1.5 bg-violet-50 dark:bg-violet-950/30 text-violet-700 dark:text-violet-400 rounded-full text-sm font-medium">${estadoLabel}</span>
                            <span class="text-gray-600 dark:text-gray-400 text-sm">${fechaInicio} - ${fechaFin}</span>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400">${campaignData.objetivo}</p>
                    </div>
                </div>
            `;
        }

        function updateStats() {
            const total = posts.length;
            const byStatus = posts.reduce((acc: Record<string, number>, p) => {
                acc[p.estado] = (acc[p.estado] || 0) + 1;
                return acc;
            }, {});
            document.getElementById("stat-todos")!.textContent = String(total);
            document.getElementById("stat-draft")!.textContent = String(
                byStatus.draft || 0,
            );
            document.getElementById("stat-scheduled")!.textContent = String(
                byStatus.scheduled || 0,
            );
            document.getElementById("stat-published")!.textContent = String(
                byStatus.published || 0,
            );
        }

        function renderPosts(
            filtros: { estado?: string; busqueda?: string } = {},
        ) {
            const container = document.getElementById("postsList");
            const emptyState = document.getElementById("emptyState");
            if (!container) return;

            let filtered = posts;
            if (filtros.estado && filtros.estado !== "todos")
                filtered = filtered.filter((p) => p.estado === filtros.estado);
            if (filtros.busqueda)
                filtered = filtered.filter((p) =>
                    p.titulo
                        .toLowerCase()
                        .includes(filtros.busqueda!.toLowerCase()),
                );

            if (filtered.length === 0) {
                container.classList.add("hidden");
                emptyState?.classList.remove("hidden");
                return;
            }

            container.classList.remove("hidden");
            emptyState?.classList.add("hidden");

            container.innerHTML = filtered
                .map((p) => {
                    const estado = estadoConfig[p.estado] || estadoConfig.draft;
                    const plataforma =
                        plataformaConfig[p.plataforma] ||
                        plataformaConfig.facebook;
                    const fechaProgramada = p.programadoPara
                        ? new Date(p.programadoPara).toLocaleDateString(
                              "es-ES",
                              {
                                  day: "numeric",
                                  month: "short",
                                  hour: "2-digit",
                                  minute: "2-digit",
                              },
                          )
                        : "";

                    return `
                    <div class="p-6 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl hover:shadow-lg transition-all">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">${plataforma.icon}</span>
                                <span class="px-2 py-1 ${estado.bg} ${estado.text} rounded-full text-xs font-medium">${estado.icon} ${estado.label}</span>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">${p.titulo}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 line-clamp-3">${p.contenido}</p>
                        ${p.estado === "scheduled" && fechaProgramada ? `<p class="text-xs text-yellow-600 mb-4">üìÖ ${fechaProgramada}</p>` : ""}
                        <div class="flex gap-2 pt-3 border-t border-gray-200 dark:border-gray-800">
                            ${p.estado === "published" ? `<button onclick="verMetricas(${p.id})" class="flex-1 px-3 py-2 text-blue-600 hover:bg-blue-50 rounded-lg text-sm font-medium">üìä M√©tricas</button>` : ""}
                            <button onclick="editarPost(${p.id})" class="flex-1 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg text-sm font-medium">Editar</button>
                            ${p.estado !== "published" ? `<button onclick="publicarPost(${p.id})" class="flex-1 px-3 py-2 text-green-600 hover:bg-green-50 rounded-lg text-sm font-medium">üöÄ Publicar</button>` : ""}
                            <button onclick="eliminarPost(${p.id})" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                })
                .join("");
        }

        // ============================================
        // GLOBAL FUNCTIONS
        // ============================================
        (window as any).editarPost = (postId: number) => {
            const post = posts.find((p) => p.id === postId);
            if (post) openModal(post);
        };

        (window as any).eliminarPost = async (postId: number) => {
            if (!confirm("¬øEliminar esta publicaci√≥n?")) return;
            try {
                await deletePost(postId);
                posts = posts.filter((p) => p.id !== postId);
                updateStats();
                renderPosts(filtrosActuales);
                showToast("Publicaci√≥n eliminada", "success");
            } catch (error) {
                showToast("Error al eliminar", "error");
            }
        };

        (window as any).publicarPost = async (postId: number) => {
            if (!confirm("¬øPublicar ahora?")) return;
            try {
                const updated = await publishPost(postId);
                const idx = posts.findIndex((p) => p.id === postId);
                if (idx !== -1) posts[idx] = updated;
                updateStats();
                renderPosts(filtrosActuales);
                showToast("¬°Publicado!", "success");
            } catch (error) {
                showToast("Error al publicar", "error");
            }
        };

        (window as any).verMetricas = async (postId: number) => {
            try {
                const metrics = await fetchPostMetrics(postId);
                const content = document.getElementById("metricsContent");
                if (content) {
                    content.innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg text-center">
                                <p class="text-2xl font-bold text-violet-600">${metrics.totales.alcance.toLocaleString()}</p>
                                <p class="text-sm text-gray-500">Alcance</p>
                            </div>
                            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg text-center">
                                <p class="text-2xl font-bold text-pink-600">${metrics.totales.likes.toLocaleString()}</p>
                                <p class="text-sm text-gray-500">Likes</p>
                            </div>
                            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg text-center">
                                <p class="text-2xl font-bold text-blue-600">${metrics.totales.comentarios.toLocaleString()}</p>
                                <p class="text-sm text-gray-500">Comentarios</p>
                            </div>
                            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg text-center">
                                <p class="text-2xl font-bold text-green-600">${metrics.totales.compartidos.toLocaleString()}</p>
                                <p class="text-sm text-gray-500">Compartidos</p>
                            </div>
                        </div>
                    `;
                }
                document
                    .getElementById("modalMetrics")
                    ?.classList.remove("hidden");
                document.getElementById("modalMetrics")?.classList.add("flex");
            } catch (error) {
                showToast("Error al cargar m√©tricas", "error");
            }
        };

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener("DOMContentLoaded", async () => {
            await loadCampaignData();

            // Platform selection
            document
                .querySelectorAll('input[name="platform"]')
                .forEach((radio) => {
                    radio.addEventListener("change", (e) => {
                        selectedPlatform = (e.target as HTMLInputElement)
                            .value as any;
                        updatePreviewPlatform();
                    });
                });

            // Content type selection
            document
                .querySelectorAll('input[name="contentType"]')
                .forEach((radio) => {
                    radio.addEventListener("change", (e) => {
                        selectedContentType = (e.target as HTMLInputElement)
                            .value as any;
                    });
                });

            // Generate AI
            document
                .getElementById("btnGenerateAI")
                ?.addEventListener("click", async () => {
                    if (!selectedPlatform) {
                        showToast("Selecciona una plataforma", "warning");
                        return;
                    }
                    if (!selectedContentType) {
                        showToast("Selecciona el tipo de contenido", "warning");
                        return;
                    }

                    const prompt = (
                        document.getElementById(
                            "postPrompt",
                        ) as HTMLTextAreaElement
                    ).value.trim();

                    if (!prompt) {
                        showToast("Escribe una descripci√≥n", "warning");
                        return;
                    }

                    if (
                        selectedPlatform === "instagram" &&
                        selectedContentType === "text"
                    ) {
                        showToast(
                            "Instagram requiere imagen o video",
                            "warning",
                        );
                        return;
                    }

                    showLoading();

                    try {
                        const tone = (
                            document.getElementById(
                                "promptTone",
                            ) as HTMLSelectElement
                        ).value;

                        // ‚úÖ NUEVO: Decidir qu√© generar seg√∫n el tipo de contenido
                        if (selectedContentType === "image") {
                            // Generar TEXTO + IMAGEN
                            const result = await generateImage(
                                prompt,
                                selectedPlatform,
                                tone,
                                {
                                    aspectRatio:
                                        selectedPlatform === "instagram"
                                            ? "1:1"
                                            : "16:9",
                                    numberOfImages: 1,
                                },
                            );

                            if (
                                result.success &&
                                result.text &&
                                result.imageUrl
                            ) {
                                // Llenar el textarea con el texto
                                (
                                    document.getElementById(
                                        "postContent",
                                    ) as HTMLTextAreaElement
                                ).value = result.text;

                                // Guardar la URL de la imagen
                                (
                                    document.getElementById(
                                        "postImageUrl",
                                    ) as HTMLInputElement
                                ).value = result.imageUrl || "";
                                (
                                    document.getElementById(
                                        "postImagePath",
                                    ) as HTMLInputElement
                                ).value = result.imageUrl || "";

                                // Extraer primera l√≠nea para el t√≠tulo
                                const firstLine = result.text
                                    .split("\n")[0]
                                    .replace(/[üìòüì∑üéì‚ú®üöÄüí°‚ù§Ô∏èüî•‚≠ê#]/g, "")
                                    .trim();
                                (
                                    document.getElementById(
                                        "postTitle",
                                    ) as HTMLInputElement
                                ).value = firstLine.slice(0, 80);

                                // ‚úÖ Mostrar la imagen en el preview
                                const imagePreviewContainer =
                                    document.querySelector(
                                        ".p-6.rounded-xl.border-2.border-dashed",
                                    ) as HTMLElement;
                                if (imagePreviewContainer && result.imageUrl) {
                                    imagePreviewContainer.innerHTML = `
                            <img src="${result.imageUrl}" alt="Imagen generada" class="w-full h-auto rounded-lg" />
                            <p class="text-xs text-green-600 mt-2">‚úÖ Imagen generada exitosamente</p>
                        `;
                                }

                                updatePreview();
                                goToStep(2);
                                showToast(
                                    "¬°Contenido e imagen generados!",
                                    "success",
                                );
                            } else {
                                showToast(
                                    result.error || "Error al generar",
                                    "error",
                                );
                            }
                        } else {
                            // Generar solo TEXTO (video o text)
                            const result = await generateText(
                                prompt,
                                selectedPlatform,
                                tone,
                            );

                            if (result.success && result.text) {
                                (
                                    document.getElementById(
                                        "postContent",
                                    ) as HTMLTextAreaElement
                                ).value = result.text;

                                const firstLine = result.text
                                    .split("\n")[0]
                                    .replace(/[üìòüì∑üéì‚ú®üöÄüí°‚ù§Ô∏èüî•‚≠ê#]/g, "")
                                    .trim();
                                (
                                    document.getElementById(
                                        "postTitle",
                                    ) as HTMLInputElement
                                ).value = firstLine.slice(0, 80);

                                updatePreview();
                                goToStep(2);
                                showToast("¬°Contenido generado!", "success");
                            } else {
                                showToast(
                                    result.error || "Error al generar",
                                    "error",
                                );
                            }
                        }
                    } catch (error) {
                        showToast("Error de conexi√≥n", "error");
                    } finally {
                        hideLoading();
                    }
                });

            // Regenerate
            document
                .getElementById("btnRegenerateAI")
                ?.addEventListener("click", () => goToStep(1));
            document
                .getElementById("btnBackToStep1")
                ?.addEventListener("click", () => goToStep(1));

            // Live preview
            document
                .getElementById("postContent")
                ?.addEventListener("input", updatePreview);

            // Open modal
            document
                .getElementById("btnNuevoPost")
                ?.addEventListener("click", () => openModal());

            // Close modal
            document
                .getElementById("btnCerrarModal")
                ?.addEventListener("click", closeModal);
            document
                .getElementById("btnCancelarModal")
                ?.addEventListener("click", closeModal);
            document
                .getElementById("btnCerrarMetrics")
                ?.addEventListener("click", () => {
                    document
                        .getElementById("modalMetrics")
                        ?.classList.add("hidden");
                    document
                        .getElementById("modalMetrics")
                        ?.classList.remove("flex");
                });

            // Form submit
            document
                .getElementById("formPost")
                ?.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const userStr = localStorage.getItem("user");
                    if (!userStr) {
                        showToast("Usuario no encontrado", "error");
                        return;
                    }
                    const user = JSON.parse(userStr);

                    const scheduledAt = (
                        document.getElementById(
                            "postScheduledAt",
                        ) as HTMLInputElement
                    ).value;
                    const status = (
                        document.getElementById(
                            "postStatus",
                        ) as HTMLSelectElement
                    ).value as any;

                    const btn = document.getElementById(
                        "btnSubmitForm",
                    ) as HTMLButtonElement;
                    btn.disabled = true;
                    btn.innerHTML = "‚è≥ Guardando...";

                    try {
                        if (isEditingPost && editingPostId) {
                            const data: UpdatePostDTO = {
                                title: (
                                    document.getElementById(
                                        "postTitle",
                                    ) as HTMLInputElement
                                ).value,
                                platform: selectedPlatform!,
                                content: (
                                    document.getElementById(
                                        "postContent",
                                    ) as HTMLTextAreaElement
                                ).value,
                                content_type: selectedContentType!,
                                image_path: (
                                    document.getElementById(
                                        "postImagePath",
                                    ) as HTMLInputElement
                                ).value,
                                link_url: (
                                    document.getElementById(
                                        "postLinkUrl",
                                    ) as HTMLInputElement
                                ).value,
                                status,
                                scheduled_at: scheduledAt || null,
                            };
                            const updated = await updatePost(
                                editingPostId,
                                data,
                            );
                            const idx = posts.findIndex(
                                (p) => p.id === editingPostId,
                            );
                            if (idx !== -1) posts[idx] = updated;
                            showToast("Publicaci√≥n actualizada", "success");
                        } else {
                            const data: CreatePostDTO = {
                                campaign_id: campaignId,
                                title: (
                                    document.getElementById(
                                        "postTitle",
                                    ) as HTMLInputElement
                                ).value,
                                platform: selectedPlatform!,
                                content: (
                                    document.getElementById(
                                        "postContent",
                                    ) as HTMLTextAreaElement
                                ).value,
                                content_type: selectedContentType!,
                                image_path: (
                                    document.getElementById(
                                        "postImagePath",
                                    ) as HTMLInputElement
                                ).value,
                                image_url:
                                    (
                                        document.getElementById(
                                            "postImageUrl",
                                        ) as HTMLInputElement
                                    ).value || null,
                                link_url: (
                                    document.getElementById(
                                        "postLinkUrl",
                                    ) as HTMLInputElement
                                ).value,
                                status,
                                scheduled_at: scheduledAt || null,
                                published_at:
                                    status === "published"
                                        ? new Date()
                                              .toISOString()
                                              .slice(0, 19)
                                              .replace("T", " ")
                                        : null,
                                created_by: user.id,
                            };
                            const created = await createPost(data);
                            posts.push(created);
                            showToast("Publicaci√≥n creada", "success");
                        }

                        updateStats();
                        renderPosts(filtrosActuales);
                        closeModal();
                    } catch (error) {
                        showToast("Error al guardar", "error");
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML =
                            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Guardar';
                    }
                });

            // Filters
            document.querySelectorAll(".filter-btn").forEach((btn) => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll(".filter-btn").forEach((b) => {
                        b.classList.remove("border-violet-500");
                        b.classList.add(
                            "border-gray-200",
                            "dark:border-gray-800",
                        );
                    });
                    btn.classList.remove(
                        "border-gray-200",
                        "dark:border-gray-800",
                    );
                    btn.classList.add("border-violet-500");
                    filtrosActuales.estado =
                        btn.getAttribute("data-filter") || "todos";
                    renderPosts(filtrosActuales);
                });
            });

            // Search
            document
                .getElementById("searchInput")
                ?.addEventListener("input", (e) => {
                    filtrosActuales.busqueda = (
                        e.target as HTMLInputElement
                    ).value;
                    renderPosts(filtrosActuales);
                });

            // Clear filters
            document
                .getElementById("btnLimpiarFiltros")
                ?.addEventListener("click", () => {
                    filtrosActuales = { estado: "todos" };
                    (
                        document.getElementById(
                            "searchInput",
                        ) as HTMLInputElement
                    ).value = "";
                    document.querySelectorAll(".filter-btn").forEach((b) => {
                        b.classList.remove("border-violet-500");
                        b.classList.add(
                            "border-gray-200",
                            "dark:border-gray-800",
                        );
                    });
                    document
                        .querySelector('[data-filter="todos"]')
                        ?.classList.add("border-violet-500");
                    renderPosts(filtrosActuales);
                });
        });
    </script>
</Layout>
